<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Integration Demo - ALSOK Interview System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        alsok: {
                            blue: '#0066CC',
                            red: '#E60012',
                            gray: '#666666'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .demo-step {
            transition: all 0.3s ease;
        }
        
        .demo-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-success { background-color: #10B981; }
        .status-pending { background-color: #6B7280; }
        .status-demo { background-color: #F59E0B; }
        .status-error { background-color: #EF4444; }
        
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        
        .log-success { background-color: #dcfce7; color: #166534; }
        .log-error { background-color: #fee2e2; color: #991b1b; }
        .log-info { background-color: #dbeafe; color: #1d4ed8; }
        .log-warning { background-color: #fef3c7; color: #92400e; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-alsok-blue">Google Sheets 統合デモ</h1>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <span class="status-dot" id="connectionStatus"></span>
                        <span id="connectionText" class="text-sm font-medium">接続確認中...</span>
                    </div>
                    <button id="refreshConnectionBtn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                        更新
                    </button>
                </div>
            </div>
            <p class="text-gray-600">ALSOK面接システムとGoogle Spreadsheetsの連携をテストします。</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Demo Actions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">デモアクション</h2>
                
                <div class="space-y-4">
                    <!-- 接続テスト -->
                    <div class="demo-step border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">1. 接続テスト</h3>
                            <span class="status-dot status-pending" id="testStatus"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">Google Sheets APIとの接続をテストします</p>
                        <button id="testConnectionBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors">
                            接続テスト実行
                        </button>
                    </div>

                    <!-- サンプルデータ送信 -->
                    <div class="demo-step border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">2. サンプルデータ送信</h3>
                            <span class="status-dot status-pending" id="sendStatus"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">模擬応募者データをスプレッドシートに送信します</p>
                        <button id="sendSampleDataBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition-colors" disabled>
                            サンプルデータ送信
                        </button>
                    </div>

                    <!-- 複数データ送信 -->
                    <div class="demo-step border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">3. 複数データ送信</h3>
                            <span class="status-dot status-pending" id="batchStatus"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">複数の応募者データを一括送信します</p>
                        <div class="flex space-x-2">
                            <input type="number" id="batchCount" class="flex-1 px-3 py-2 border rounded-md" placeholder="送信数" min="1" max="10" value="3">
                            <button id="sendBatchDataBtn" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md transition-colors" disabled>
                                一括送信
                            </button>
                        </div>
                    </div>

                    <!-- スプレッドシート確認 -->
                    <div class="demo-step border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">4. スプレッドシート確認</h3>
                            <span class="status-dot status-pending" id="viewStatus"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">送信されたデータをスプレッドシートで確認します</p>
                        <button id="viewSheetBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md transition-colors" disabled>
                            スプレッドシートを開く
                        </button>
                    </div>
                </div>

                <!-- Demo Data Preview -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-800 mb-2">送信予定データ例</h3>
                    <div class="text-xs text-gray-600 space-y-1" id="sampleDataPreview">
                        <!-- 動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- Log Output -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">実行ログ</h2>
                    <button id="clearLogBtn" class="text-sm text-gray-500 hover:text-gray-700">
                        クリア
                    </button>
                </div>
                
                <div id="logOutput" class="bg-gray-50 rounded-lg p-4 h-80 overflow-y-auto">
                    <div class="log-entry log-info">システム初期化中...</div>
                </div>
            </div>
        </div>

        <!-- Configuration Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">設定情報</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-medium text-gray-800 mb-2">現在の設定</h3>
                    <div class="bg-gray-50 rounded-lg p-3 text-sm space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">API接続:</span>
                            <span id="configApiStatus">未確認</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">スプレッドシート:</span>
                            <span id="configSheetStatus">未設定</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">モード:</span>
                            <span id="configMode">デモ</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-medium text-gray-800 mb-2">クイック設定</h3>
                    <div class="space-y-2">
                        <button id="setupDemoModeBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-md text-sm">
                            デモモード設定
                        </button>
                        <button id="openSetupPageBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md text-sm">
                            詳細設定ページを開く
                        </button>
                        <button id="exportTemplateBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md text-sm">
                            テンプレートダウンロード
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-6 text-center space-x-4">
            <a href="admin-dashboard.html" class="inline-flex items-center text-alsok-blue hover:text-alsok-red">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                管理画面に戻る
            </a>
            <span class="text-gray-400">|</span>
            <a href="google-sheets-setup.html" class="text-alsok-blue hover:text-alsok-red">
                設定ページ
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="shared-storage.js"></script>
    <script src="google-sheets-config.js"></script>
    <script src="google-sheets-api.js"></script>
    <script>
        class GoogleSheetsDemo {
            constructor() {
                this.isInitialized = false;
                this.sheetsAPI = null;
                
                this.initializeUI();
                this.bindEvents();
                this.startInitialization();
            }

            initializeUI() {
                this.logOutput = document.getElementById('logOutput');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.connectionText = document.getElementById('connectionText');
                
                // Status dots
                this.testStatus = document.getElementById('testStatus');
                this.sendStatus = document.getElementById('sendStatus');
                this.batchStatus = document.getElementById('batchStatus');
                this.viewStatus = document.getElementById('viewStatus');
                
                // Buttons
                this.testConnectionBtn = document.getElementById('testConnectionBtn');
                this.sendSampleDataBtn = document.getElementById('sendSampleDataBtn');
                this.sendBatchDataBtn = document.getElementById('sendBatchDataBtn');
                this.viewSheetBtn = document.getElementById('viewSheetBtn');
                
                this.generateSampleDataPreview();
            }

            bindEvents() {
                // Demo action buttons
                this.testConnectionBtn.addEventListener('click', () => this.testConnection());
                this.sendSampleDataBtn.addEventListener('click', () => this.sendSampleData());
                this.sendBatchDataBtn.addEventListener('click', () => this.sendBatchData());
                this.viewSheetBtn.addEventListener('click', () => this.viewSpreadsheet());
                
                // Control buttons
                document.getElementById('refreshConnectionBtn').addEventListener('click', () => this.refreshConnection());
                document.getElementById('clearLogBtn').addEventListener('click', () => this.clearLog());
                document.getElementById('setupDemoModeBtn').addEventListener('click', () => this.setupDemoMode());
                document.getElementById('openSetupPageBtn').addEventListener('click', () => this.openSetupPage());
                document.getElementById('exportTemplateBtn').addEventListener('click', () => this.exportTemplate());
                
                // Connection status listener
                document.addEventListener('sheetsConnectionStatus', (e) => {
                    this.updateConnectionDisplay(e.detail);
                });
            }

            async startInitialization() {
                this.log('システム初期化を開始します...', 'info');
                
                try {
                    const result = await initializeGoogleSheets();
                    this.isInitialized = result.success || result.message?.includes('デモ');
                    
                    if (this.isInitialized) {
                        this.log('✅ 初期化完了: ' + result.message, 'success');
                        this.enableButtons();
                    } else {
                        this.log('⚠️ 初期化警告: ' + result.message, 'warning');
                        this.setupDemoMode();
                    }
                    
                    this.updateConnectionDisplay({ status: result.success ? 'connected' : 'demo_mode' });
                    this.updateConfigDisplay();
                } catch (error) {
                    this.log('❌ 初期化エラー: ' + error.message, 'error');
                    this.updateConnectionDisplay({ status: 'error' });
                }
            }

            async testConnection() {
                this.log('接続テストを実行中...', 'info');
                this.testStatus.className = 'status-dot status-pending';
                
                try {
                    const result = await initializeGoogleSheets();
                    
                    if (result.success) {
                        this.log('✅ 接続テスト成功: ' + result.message, 'success');
                        this.testStatus.className = 'status-dot status-success';
                        this.enableButtons();
                    } else {
                        this.log('⚠️ 接続テスト (デモモード): ' + result.message, 'warning');
                        this.testStatus.className = 'status-dot status-demo';
                        this.enableButtons();
                    }
                } catch (error) {
                    this.log('❌ 接続テストエラー: ' + error.message, 'error');
                    this.testStatus.className = 'status-dot status-error';
                }
            }

            async sendSampleData() {
                this.log('サンプルデータ送信を開始...', 'info');
                this.sendStatus.className = 'status-dot status-pending';
                
                try {
                    const sampleData = this.generateSampleApplicantData();
                    const result = await submitToGoogleSheets(sampleData);
                    
                    if (result.success) {
                        this.log('✅ サンプルデータ送信成功', 'success');
                        this.sendStatus.className = 'status-dot status-success';
                        this.viewSheetBtn.disabled = false;
                        
                        if (result.sheetUrl) {
                            this.log('📊 スプレッドシートURL: ' + result.sheetUrl, 'info');
                        }
                    } else {
                        this.log('⚠️ サンプルデータ送信 (デモ): ' + result.message, 'warning');
                        this.sendStatus.className = 'status-dot status-demo';
                    }
                } catch (error) {
                    this.log('❌ サンプルデータ送信エラー: ' + error.message, 'error');
                    this.sendStatus.className = 'status-dot status-error';
                }
            }

            async sendBatchData() {
                const count = parseInt(document.getElementById('batchCount').value) || 3;
                this.log(`一括データ送信を開始 (${count}件)...`, 'info');
                this.batchStatus.className = 'status-dot status-pending';
                
                try {
                    let successCount = 0;
                    
                    for (let i = 0; i < count; i++) {
                        const sampleData = this.generateSampleApplicantData(i + 1);
                        const result = await submitToGoogleSheets(sampleData);
                        
                        if (result.success || result.demo) {
                            successCount++;
                            this.log(`📤 データ ${i + 1}/${count} 送信完了`, 'success');
                        } else {
                            this.log(`❌ データ ${i + 1}/${count} 送信失敗: ${result.message}`, 'error');
                        }
                        
                        // 短い間隔で送信
                        if (i < count - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    this.log(`✅ 一括送信完了: ${successCount}/${count}件成功`, 'success');
                    this.batchStatus.className = 'status-dot status-success';
                    this.viewSheetBtn.disabled = false;
                } catch (error) {
                    this.log('❌ 一括送信エラー: ' + error.message, 'error');
                    this.batchStatus.className = 'status-dot status-error';
                }
            }

            viewSpreadsheet() {
                const status = getGoogleSheetsStatus();
                
                if (status.hasCredentials && googleSheetsAPI?.getSheetUrl()) {
                    const url = googleSheetsAPI.getSheetUrl();
                    window.open(url, '_blank');
                    this.log('📊 スプレッドシートを新しいタブで開きました', 'info');
                    this.viewStatus.className = 'status-dot status-success';
                } else {
                    this.log('⚠️ デモモード - スプレッドシートURLが利用できません', 'warning');
                    this.viewStatus.className = 'status-dot status-demo';
                }
            }

            generateSampleApplicantData(index = 1) {
                const names = ['田中太郎', '佐藤花子', '鈴木一郎', '高橋美咲', '渡辺健太'];
                const name = names[(index - 1) % names.length];
                
                return {
                    applicantName: name,
                    phoneNumber: `090-1234-${String(5670 + index).padStart(4, '0')}`,
                    applicationSource: 'デモ応募',
                    step1_answer: '18歳以上です',
                    step2_answer: '日本国籍です',
                    step3_answer: 'ありません',
                    step4_answer: 'ありません',
                    step5_answer: 'ありません',
                    step6_answer: 'ありません',
                    step7_answer: 'ありません',
                    step8_answer: '東京都内在住',
                    step9_answer: '提供した番号で連絡可能',
                    step10_answer: 'はい、希望します',
                    step11_answer: '特にありません',
                    disqualificationStatus: '適格',
                    overallResult: '面接実施予定',
                    completionTime: new Date().toLocaleString('ja-JP'),
                    sessionId: `demo_session_${index}_${Date.now()}`,
                    notes: `デモデータ #${index}`
                };
            }

            generateSampleDataPreview() {
                const sampleData = this.generateSampleApplicantData();
                const preview = document.getElementById('sampleDataPreview');
                
                preview.innerHTML = `
                    <div><strong>応募者名:</strong> ${sampleData.applicantName}</div>
                    <div><strong>電話番号:</strong> ${sampleData.phoneNumber}</div>
                    <div><strong>年齢確認:</strong> ${sampleData.step1_answer}</div>
                    <div><strong>国籍確認:</strong> ${sampleData.step2_answer}</div>
                    <div><strong>総合結果:</strong> ${sampleData.overallResult}</div>
                    <div class="text-gray-500 mt-1">... 他22項目</div>
                `;
            }

            setupDemoMode() {
                this.log('デモモード設定を実行中...', 'info');
                
                const demoConfig = googleSheetsConfig.getDemoConfig();
                googleSheetsConfig.saveConfig(demoConfig);
                
                this.log('✅ デモモード設定完了', 'success');
                this.updateConnectionDisplay({ status: 'demo_mode' });
                this.updateConfigDisplay();
                this.enableButtons();
            }

            openSetupPage() {
                window.open('google-sheets-setup.html', '_blank');
                this.log('📝 設定ページを新しいタブで開きました', 'info');
            }

            exportTemplate() {
                const headers = [
                    '応募日時', '応募者名', '電話番号', '応募経路', '年齢確認', '国籍確認',
                    '過去の逮捕歴', '暴力団関係', '精神的な病気', 'アルコール依存症', '薬物依存症',
                    '住居確認', '連絡先確認', '面接希望', '特記事項', '失格状況', '総合結果',
                    '完了時間', 'デバイス種別', 'IPアドレス', 'ユーザーエージェント', 'セッションID',
                    'リファラー', '画面解像度', '言語設定', 'タイムゾーン', '備考'
                ];
                
                const csv = '\uFEFF' + headers.join(',') + '\n';
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'ALSOK_スプレッドシートテンプレート.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.log('📁 テンプレートファイルをダウンロードしました', 'success');
            }

            async refreshConnection() {
                this.log('接続状況を更新中...', 'info');
                await this.startInitialization();
            }

            enableButtons() {
                this.sendSampleDataBtn.disabled = false;
                this.sendBatchDataBtn.disabled = false;
            }

            updateConnectionDisplay(detail) {
                let statusClass = '';
                let statusText = '';
                
                switch (detail.status) {
                    case 'connected':
                        statusClass = 'status-success';
                        statusText = '接続済み';
                        break;
                    case 'demo_mode':
                        statusClass = 'status-demo';
                        statusText = 'デモモード';
                        break;
                    case 'error':
                        statusClass = 'status-error';
                        statusText = 'エラー';
                        break;
                    default:
                        statusClass = 'status-pending';
                        statusText = '未接続';
                }
                
                this.connectionStatus.className = `status-dot ${statusClass}`;
                this.connectionText.textContent = statusText;
            }

            updateConfigDisplay() {
                const status = getGoogleSheetsStatus();
                const credentials = googleSheetsConfig.getCredentials();
                
                document.getElementById('configApiStatus').textContent = 
                    credentials.apiKey ? '設定済み' : '未設定';
                document.getElementById('configSheetStatus').textContent = 
                    credentials.sheetId ? '設定済み' : '未設定';
                document.getElementById('configMode').textContent = 
                    status.isAuthenticated ? 'ライブ' : 'デモ';
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                this.logOutput.appendChild(logEntry);
                this.logOutput.scrollTop = this.logOutput.scrollHeight;
            }

            clearLog() {
                this.logOutput.innerHTML = '<div class="log-entry log-info">ログをクリアしました</div>';
            }
        }

        // Initialize demo when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new GoogleSheetsDemo();
        });
    </script>
</body>
</html>