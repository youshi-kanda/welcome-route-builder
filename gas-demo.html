<!DOCTYPE html>
<html lang="ja">
<head>
    <!DOCTYPE html>
    <html lang="ja">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Archived: GAS demo</title>
      <meta http-equiv="refresh" content="0;url=/demos/gas-demo.html">
    </head>
    <body>
      <p>This demo has been archived to <a href="/demos/gas-demo.html">/demos/gas-demo.html</a>.</p>
      <p><a href="/demos/gas-demo.html">Open archived GAS demo</a></p>
    </body>
    </html>
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">応募者名</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">電話番号</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">年齢確認</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">国籍確認</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">総合結果</th>
                        </tr>
                    </thead>
                    <tbody id="sampleDataTable" class="bg-white divide-y divide-gray-200">
                        <!-- 動的に生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-xs text-gray-500">
                💡 上記はデモ送信時に使用されるサンプルデータです。実際には27列のデータが送信されます。
            </div>
        </div>

        <!-- Statistics -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">📊 送信統計</h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="statTotal">0</div>
                    <div class="text-sm text-gray-600">総送信数</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="statSuccess">0</div>
                    <div class="text-sm text-gray-600">成功数</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="statError">0</div>
                    <div class="text-sm text-gray-600">エラー数</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="statRate">0%</div>
                    <div class="text-sm text-gray-600">成功率</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-6 text-center space-x-4">
            <a href="admin-dashboard.html" class="inline-flex items-center text-alsok-blue hover:text-alsok-red">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                管理画面に戻る
            </a>
            <span class="text-gray-400">|</span>
            <a href="gas-setup.html" class="text-alsok-blue hover:text-alsok-red">
                GAS設定ページ
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/infra/gas/gas-integration.js"></script>
    <script>
        class GASDemo {
            constructor() {
                this.gasIntegration = null;
                this.stats = {
                    total: 0,
                    success: 0,
                    error: 0
                };
                
                this.initializeUI();
                this.bindEvents();
                this.startInitialization();
            }

            initializeUI() {
                this.logOutput = document.getElementById('logOutput');
                this.updateConnectionStatus('pending');
                this.generateSampleDataTable();
                this.updateStatistics();
            }

            bindEvents() {
                // Demo action buttons
                document.getElementById('testConnectionBtn').addEventListener('click', () => this.testConnection());
                document.getElementById('sendSingleBtn').addEventListener('click', () => this.sendSingleData());
                document.getElementById('sendBatchBtn').addEventListener('click', () => this.sendBatchData());
                document.getElementById('viewSpreadsheetBtn').addEventListener('click', () => this.viewSpreadsheet());
                
                // Utility buttons
                document.getElementById('refreshBtn').addEventListener('click', () => this.refresh());
                document.getElementById('clearLogBtn').addEventListener('click', () => this.clearLog());
                document.getElementById('exportLogBtn').addEventListener('click', () => this.exportLog());
                document.getElementById('openSettingsBtn').addEventListener('click', () => this.openSettings());
                
                // Connection status listener
                document.addEventListener('gasConnectionStatus', (e) => {
                    this.updateConnectionStatus(e.detail.status);
                });
            }

            async startInitialization() {
                this.log('🚀 GAS連携デモを初期化中...', 'info');
                
                try {
                    this.gasIntegration = initializeGASIntegration();
                    const status = this.gasIntegration.getStatus();
                    
                    this.log(`📊 GAS設定状況: 有効=${status.isEnabled}, URL=${status.hasUrl}`, 'info');
                    
                    if (status.hasUrl) {
                        document.getElementById('currentUrl').textContent = `URL: ${status.url}`;
                        this.updateQuickStatus();
                        
                        if (status.isEnabled) {
                            this.enableButtons();
                            this.updateConnectionStatus('connected');
                            this.log('✅ GAS連携準備完了', 'success');
                        } else {
                            this.updateConnectionStatus('disconnected');
                            this.log('⚠️ GAS連携が無効です', 'warning');
                        }
                    } else {
                        this.updateConnectionStatus('disconnected');
                        this.log('❌ GAS Web App URLが未設定です', 'error');
                    }
                    
                } catch (error) {
                    this.log('❌ 初期化エラー: ' + error.message, 'error');
                    this.updateConnectionStatus('error');
                }
            }

            async testConnection() {
                this.log('🔌 接続テスト開始...', 'info');
                this.updateStatusDot('testStatus', 'sending');
                
                try {
                    const result = await testGASConnection();
                    
                    if (result.success) {
                        this.log('✅ 接続テスト成功: ' + result.message, 'success');
                        this.updateStatusDot('testStatus', 'success');
                        this.updateConnectionStatus('connected');
                        this.enableButtons();
                        this.updateQuickStatus();
                    } else {
                        this.log('❌ 接続テスト失敗: ' + result.message, 'error');
                        this.updateStatusDot('testStatus', 'error');
                        this.updateConnectionStatus('error');
                    }
                } catch (error) {
                    this.log('❌ 接続テストエラー: ' + error.message, 'error');
                    this.updateStatusDot('testStatus', 'error');
                    this.updateConnectionStatus('error');
                }
            }

            async sendSingleData() {
                this.log('📤 単体データ送信開始...', 'info');
                this.updateStatusDot('singleStatus', 'sending');
                
                try {
                    const results = await this.gasIntegration.sendDemoData(1);
                    this.stats.total++;
                    
                    if (results[0].success) {
                        this.stats.success++;
                        this.log('✅ 単体データ送信成功', 'success');
                        this.updateStatusDot('singleStatus', 'success');
                        
                        if (results[0].response?.spreadsheetUrl) {
                            document.getElementById('viewSpreadsheetBtn').disabled = false;
                            this.log(`📊 スプレッドシートURL: ${results[0].response.spreadsheetUrl}`, 'info');
                        }
                    } else {
                        this.stats.error++;
                        this.log('❌ 単体データ送信失敗: ' + results[0].message, 'error');
                        this.updateStatusDot('singleStatus', 'error');
                    }
                } catch (error) {
                    this.stats.error++;
                    this.log('❌ 送信エラー: ' + error.message, 'error');
                    this.updateStatusDot('singleStatus', 'error');
                }
                
                this.updateStatistics();
                this.updateQuickStatus();
            }

            async sendBatchData() {
                const count = parseInt(document.getElementById('batchCount').value);
                this.log(`📊 複数データ送信開始 (${count}件)...`, 'info');
                this.updateStatusDot('batchStatus', 'sending');
                
                // Progress bar setup
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                let successCount = 0;
                
                try {
                    for (let i = 0; i < count; i++) {
                        // Progress update
                        const progress = ((i) / count * 100).toFixed(0);
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${i}/${count}`;
                        
                        // Send data
                        const results = await this.gasIntegration.sendDemoData(1);
                        this.stats.total++;
                        
                        if (results[0].success) {
                            this.stats.success++;
                            successCount++;
                            this.log(`📤 データ ${i + 1}/${count} 送信完了`, 'success');
                        } else {
                            this.stats.error++;
                            this.log(`❌ データ ${i + 1}/${count} 送信失敗: ${results[0].message}`, 'error');
                        }
                        
                        // Short delay between requests
                        if (i < count - 1) {
                            await this.sleep(500);
                        }
                    }
                    
                    // Final progress
                    progressBar.style.width = '100%';
                    progressText.textContent = `${count}/${count}`;
                    
                    this.log(`✅ 複数データ送信完了: ${successCount}/${count}件成功`, 'success');
                    this.updateStatusDot('batchStatus', 'success');
                    
                    if (successCount > 0) {
                        document.getElementById('viewSpreadsheetBtn').disabled = false;
                    }
                    
                } catch (error) {
                    this.log('❌ 複数データ送信エラー: ' + error.message, 'error');
                    this.updateStatusDot('batchStatus', 'error');
                }
                
                this.updateStatistics();
                this.updateQuickStatus();
                
                // Reset progress after delay
                setTimeout(() => {
                    progressBar.style.width = '0%';
                    progressText.textContent = '0/0';
                }, 3000);
            }

            async viewSpreadsheet() {
                const status = this.gasIntegration.getStatus();
                
                if (status.hasUrl) {
                    // Try to get the spreadsheet URL from the last response
                    // For demo purposes, we'll open the GAS setup page
                    this.log('📊 スプレッドシート確認機能は実装中です', 'warning');
                    this.log('💡 実際の運用時はスプレッドシートが直接開きます', 'info');
                    this.updateStatusDot('viewStatus', 'success');
                } else {
                    this.log('❌ スプレッドシートURLが利用できません', 'error');
                    this.updateStatusDot('viewStatus', 'error');
                }
            }

            async refresh() {
                this.log('🔄 システム状態を更新中...', 'info');
                await this.startInitialization();
            }

            enableButtons() {
                document.getElementById('sendSingleBtn').disabled = false;
                document.getElementById('sendBatchBtn').disabled = false;
            }

            updateConnectionStatus(status) {
                const indicator = document.getElementById('connectionStatus');
                const text = document.getElementById('connectionText');
                
                indicator.className = 'status-dot';
                
                let statusText = '';
                switch (status) {
                    case 'connected':
                        indicator.classList.add('status-success');
                        statusText = '接続済み';
                        break;
                    case 'sending':
                        indicator.classList.add('status-sending');
                        statusText = '送信中...';
                        break;
                    case 'error':
                        indicator.classList.add('status-error');
                        statusText = 'エラー';
                        break;
                    case 'pending':
                    default:
                        indicator.classList.add('status-pending');
                        statusText = '未接続';
                }
                
                text.textContent = statusText;
            }

            updateStatusDot(elementId, status) {
                const dot = document.getElementById(elementId);
                if (dot) {
                    dot.className = 'status-dot status-' + status;
                }
            }

            updateQuickStatus() {
                const status = this.gasIntegration ? this.gasIntegration.getStatus() : {};
                
                document.getElementById('quickStatus1').textContent = status.isEnabled ? '有効' : '無効';
                document.getElementById('quickStatus2').textContent = status.hasUrl ? '設定済み' : '未設定';
                document.getElementById('quickStatus3').textContent = this.stats.total > 0 ? '送信済み' : '待機中';
                
                const rate = this.stats.total > 0 ? (this.stats.success / this.stats.total * 100).toFixed(0) : 0;
                document.getElementById('quickStatus4').textContent = rate + '%';
            }

            updateStatistics() {
                document.getElementById('statTotal').textContent = this.stats.total;
                document.getElementById('statSuccess').textContent = this.stats.success;
                document.getElementById('statError').textContent = this.stats.error;
                
                const rate = this.stats.total > 0 ? (this.stats.success / this.stats.total * 100).toFixed(0) : 0;
                document.getElementById('statRate').textContent = rate + '%';
            }

            generateSampleDataTable() {
                const sampleData = [
                    ['田中太郎（デモ1）', '090-DEMO-1001', '18歳以上です', '日本国籍です', '面接実施予定'],
                    ['佐藤花子（デモ2）', '090-DEMO-1002', '18歳以上です', '日本国籍です', '面接実施予定'],
                    ['鈴木一郎（デモ3）', '090-DEMO-1003', '18歳以上です', '日本国籍です', '面接実施予定']
                ];
                
                const tableBody = document.getElementById('sampleDataTable');
                tableBody.innerHTML = '';
                
                sampleData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = row.map(cell => `<td class="px-4 py-2 text-sm text-gray-900">${cell}</td>`).join('');
                    tableBody.appendChild(tr);
                });
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                this.logOutput.appendChild(logEntry);
                this.logOutput.scrollTop = this.logOutput.scrollHeight;
            }

            clearLog() {
                this.logOutput.innerHTML = '<div class="log-entry log-info">🗑️ ログをクリアしました</div>';
            }

            exportLog() {
                const logs = Array.from(this.logOutput.children).map(entry => entry.textContent).join('\n');
                const blob = new Blob([logs], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `gas-demo-log-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.log('📁 ログをエクスポートしました', 'success');
            }

            openSettings() {
                window.open('gas-setup.html', '_blank');
                this.log('📝 GAS設定ページを新しいタブで開きました', 'info');
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize demo when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new GASDemo();
        });
    </script>
</body>
</html>