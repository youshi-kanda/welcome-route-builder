<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Apps Script 連携デモ - ALSOK Interview System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        alsok: {
                            blue: '#0066CC',
                            red: '#E60012',
                            gray: '#666666'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .demo-card {
            transition: all 0.3s ease;
        }
        
        .demo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-success { background-color: #10B981; }
        .status-pending { background-color: #6B7280; }
        .status-error { background-color: #EF4444; }
        .status-sending { 
            background-color: #F59E0B; 
            animation: pulse 2s infinite;
        }
        
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid transparent;
        }
        
        .log-success { 
            background-color: #dcfce7; 
            color: #166534; 
            border-left-color: #10b981;
        }
        .log-error { 
            background-color: #fee2e2; 
            color: #991b1b;
            border-left-color: #ef4444; 
        }
        .log-info { 
            background-color: #dbeafe; 
            color: #1d4ed8;
            border-left-color: #3b82f6; 
        }
        .log-warning { 
            background-color: #fef3c7; 
            color: #92400e;
            border-left-color: #f59e0b; 
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-alsok-blue">Google Apps Script 連携デモ</h1>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <span class="status-dot" id="connectionStatus"></span>
                        <span id="connectionText" class="text-sm font-medium">接続確認中...</span>
                    </div>
                    <button id="refreshBtn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded">
                        🔄 更新
                    </button>
                </div>
            </div>
            <p class="text-gray-600">ALSOK面接システムとGoogle Apps Script (GAS)の連携をテスト・デモします。</p>
        </div>

        <!-- Quick Status -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-2">🔌</div>
                <div class="text-sm text-gray-600">GAS接続</div>
                <div id="quickStatus1" class="font-medium text-gray-800">確認中...</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-2">📊</div>
                <div class="text-sm text-gray-600">スプレッドシート</div>
                <div id="quickStatus2" class="font-medium text-gray-800">準備中...</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-2">📤</div>
                <div class="text-sm text-gray-600">データ送信</div>
                <div id="quickStatus3" class="font-medium text-gray-800">待機中</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-2xl mb-2">📈</div>
                <div class="text-sm text-gray-600">成功率</div>
                <div id="quickStatus4" class="font-medium text-gray-800">0%</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Demo Actions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">🧪 デモアクション</h2>
                
                <div class="space-y-4">
                    <!-- 接続テスト -->
                    <div class="demo-card border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">1. 接続テスト</h3>
                            <span class="status-dot status-pending" id="testStatus"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">GAS Web Appとの接続をテストします</p>
                        <button id="testConnectionBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors">
                            🔌 接続テスト実行
                        </button>
                    </div>

                    <!-- 単体データ送信 -->
                    <div class="demo-card border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">2. 単体データ送信</h3>
                            <span class="status-dot status-pending" id="singleStatus"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">1件の模擬応募者データを送信します</p>
                        <button id="sendSingleBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition-colors" disabled>
                            📤 単体データ送信
                        </button>
                    </div>

                    <!-- 複数データ送信 -->
                    <div class="demo-card border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">3. 複数データ送信</h3>
                            <span class="status-dot status-pending" id="batchStatus"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">複数の模擬応募者データを一括送信します</p>
                        <div class="flex space-x-2 mb-3">
                            <select id="batchCount" class="flex-1 px-3 py-2 border rounded-md">
                                <option value="3">3件</option>
                                <option value="5">5件</option>
                                <option value="10">10件</option>
                            </select>
                            <button id="sendBatchBtn" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md transition-colors" disabled>
                                📊 一括送信
                            </button>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-2">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>進行状況</span>
                                <span id="progressText">0/0</span>
                            </div>
                            <div class="bg-gray-300 rounded-full h-2">
                                <div id="progressBar" class="progress-bar bg-purple-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- スプレッドシート確認 -->
                    <div class="demo-card border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800">4. スプレッドシート確認</h3>
                            <span class="status-dot status-pending" id="viewStatus"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">送信されたデータをスプレッドシートで確認します</p>
                        <button id="viewSpreadsheetBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md transition-colors" disabled>
                            📋 スプレッドシートを開く
                        </button>
                    </div>
                </div>

                <!-- Settings Quick Access -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-2">⚙️ 設定</h3>
                    <div class="space-y-2">
                        <button id="openSettingsBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded text-sm">
                            GAS設定ページを開く
                        </button>
                        <div class="text-xs text-blue-600" id="currentUrl">
                            URL: 未設定
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Output -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">📋 実行ログ</h2>
                    <div class="space-x-2">
                        <button id="clearLogBtn" class="text-sm text-gray-500 hover:text-gray-700">
                            🗑️ クリア
                        </button>
                        <button id="exportLogBtn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded">
                            📁 エクスポート
                        </button>
                    </div>
                </div>
                
                <div id="logOutput" class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto">
                    <div class="log-entry log-info">🚀 GAS連携デモシステム起動</div>
                </div>
            </div>
        </div>

        <!-- Sample Data Preview -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">📄 サンプルデータプレビュー</h2>
            
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">応募者名</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">電話番号</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">年齢確認</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">国籍確認</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">総合結果</th>
                        </tr>
                    </thead>
                    <tbody id="sampleDataTable" class="bg-white divide-y divide-gray-200">
                        <!-- 動的に生成 -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-xs text-gray-500">
                💡 上記はデモ送信時に使用されるサンプルデータです。実際には27列のデータが送信されます。
            </div>
        </div>

        <!-- Statistics -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">📊 送信統計</h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="statTotal">0</div>
                    <div class="text-sm text-gray-600">総送信数</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="statSuccess">0</div>
                    <div class="text-sm text-gray-600">成功数</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="statError">0</div>
                    <div class="text-sm text-gray-600">エラー数</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="statRate">0%</div>
                    <div class="text-sm text-gray-600">成功率</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-6 text-center space-x-4">
            <a href="admin-dashboard.html" class="inline-flex items-center text-alsok-blue hover:text-alsok-red">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                管理画面に戻る
            </a>
            <span class="text-gray-400">|</span>
            <a href="gas-setup.html" class="text-alsok-blue hover:text-alsok-red">
                GAS設定ページ
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="gas-integration.js"></script>
    <script>
        class GASDemo {
            constructor() {
                this.gasIntegration = null;
                this.stats = {
                    total: 0,
                    success: 0,
                    error: 0
                };
                
                this.initializeUI();
                this.bindEvents();
                this.startInitialization();
            }

            initializeUI() {
                this.logOutput = document.getElementById('logOutput');
                this.updateConnectionStatus('pending');
                this.generateSampleDataTable();
                this.updateStatistics();
            }

            bindEvents() {
                // Demo action buttons
                document.getElementById('testConnectionBtn').addEventListener('click', () => this.testConnection());
                document.getElementById('sendSingleBtn').addEventListener('click', () => this.sendSingleData());
                document.getElementById('sendBatchBtn').addEventListener('click', () => this.sendBatchData());
                document.getElementById('viewSpreadsheetBtn').addEventListener('click', () => this.viewSpreadsheet());
                
                // Utility buttons
                document.getElementById('refreshBtn').addEventListener('click', () => this.refresh());
                document.getElementById('clearLogBtn').addEventListener('click', () => this.clearLog());
                document.getElementById('exportLogBtn').addEventListener('click', () => this.exportLog());
                document.getElementById('openSettingsBtn').addEventListener('click', () => this.openSettings());
                
                // Connection status listener
                document.addEventListener('gasConnectionStatus', (e) => {
                    this.updateConnectionStatus(e.detail.status);
                });
            }

            async startInitialization() {
                this.log('🚀 GAS連携デモを初期化中...', 'info');
                
                try {
                    this.gasIntegration = initializeGASIntegration();
                    const status = this.gasIntegration.getStatus();
                    
                    this.log(`📊 GAS設定状況: 有効=${status.isEnabled}, URL=${status.hasUrl}`, 'info');
                    
                    if (status.hasUrl) {
                        document.getElementById('currentUrl').textContent = `URL: ${status.url}`;
                        this.updateQuickStatus();
                        
                        if (status.isEnabled) {
                            this.enableButtons();
                            this.updateConnectionStatus('connected');
                            this.log('✅ GAS連携準備完了', 'success');
                        } else {
                            this.updateConnectionStatus('disconnected');
                            this.log('⚠️ GAS連携が無効です', 'warning');
                        }
                    } else {
                        this.updateConnectionStatus('disconnected');
                        this.log('❌ GAS Web App URLが未設定です', 'error');
                    }
                    
                } catch (error) {
                    this.log('❌ 初期化エラー: ' + error.message, 'error');
                    this.updateConnectionStatus('error');
                }
            }

            async testConnection() {
                this.log('🔌 接続テスト開始...', 'info');
                this.updateStatusDot('testStatus', 'sending');
                
                try {
                    const result = await testGASConnection();
                    
                    if (result.success) {
                        this.log('✅ 接続テスト成功: ' + result.message, 'success');
                        this.updateStatusDot('testStatus', 'success');
                        this.updateConnectionStatus('connected');
                        this.enableButtons();
                        this.updateQuickStatus();
                    } else {
                        this.log('❌ 接続テスト失敗: ' + result.message, 'error');
                        this.updateStatusDot('testStatus', 'error');
                        this.updateConnectionStatus('error');
                    }
                } catch (error) {
                    this.log('❌ 接続テストエラー: ' + error.message, 'error');
                    this.updateStatusDot('testStatus', 'error');
                    this.updateConnectionStatus('error');
                }
            }

            async sendSingleData() {
                this.log('📤 単体データ送信開始...', 'info');
                this.updateStatusDot('singleStatus', 'sending');
                
                try {
                    const results = await this.gasIntegration.sendDemoData(1);
                    this.stats.total++;
                    
                    if (results[0].success) {
                        this.stats.success++;
                        this.log('✅ 単体データ送信成功', 'success');
                        this.updateStatusDot('singleStatus', 'success');
                        
                        if (results[0].response?.spreadsheetUrl) {
                            document.getElementById('viewSpreadsheetBtn').disabled = false;
                            this.log(`📊 スプレッドシートURL: ${results[0].response.spreadsheetUrl}`, 'info');
                        }
                    } else {
                        this.stats.error++;
                        this.log('❌ 単体データ送信失敗: ' + results[0].message, 'error');
                        this.updateStatusDot('singleStatus', 'error');
                    }
                } catch (error) {
                    this.stats.error++;
                    this.log('❌ 送信エラー: ' + error.message, 'error');
                    this.updateStatusDot('singleStatus', 'error');
                }
                
                this.updateStatistics();
                this.updateQuickStatus();
            }

            async sendBatchData() {
                const count = parseInt(document.getElementById('batchCount').value);
                this.log(`📊 複数データ送信開始 (${count}件)...`, 'info');
                this.updateStatusDot('batchStatus', 'sending');
                
                // Progress bar setup
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                let successCount = 0;
                
                try {
                    for (let i = 0; i < count; i++) {
                        // Progress update
                        const progress = ((i) / count * 100).toFixed(0);
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `${i}/${count}`;
                        
                        // Send data
                        const results = await this.gasIntegration.sendDemoData(1);
                        this.stats.total++;
                        
                        if (results[0].success) {
                            this.stats.success++;
                            successCount++;
                            this.log(`📤 データ ${i + 1}/${count} 送信完了`, 'success');
                        } else {
                            this.stats.error++;
                            this.log(`❌ データ ${i + 1}/${count} 送信失敗: ${results[0].message}`, 'error');
                        }
                        
                        // Short delay between requests
                        if (i < count - 1) {
                            await this.sleep(500);
                        }
                    }
                    
                    // Final progress
                    progressBar.style.width = '100%';
                    progressText.textContent = `${count}/${count}`;
                    
                    this.log(`✅ 複数データ送信完了: ${successCount}/${count}件成功`, 'success');
                    this.updateStatusDot('batchStatus', 'success');
                    
                    if (successCount > 0) {
                        document.getElementById('viewSpreadsheetBtn').disabled = false;
                    }
                    
                } catch (error) {
                    this.log('❌ 複数データ送信エラー: ' + error.message, 'error');
                    this.updateStatusDot('batchStatus', 'error');
                }
                
                this.updateStatistics();
                this.updateQuickStatus();
                
                // Reset progress after delay
                setTimeout(() => {
                    progressBar.style.width = '0%';
                    progressText.textContent = '0/0';
                }, 3000);
            }

            async viewSpreadsheet() {
                const status = this.gasIntegration.getStatus();
                
                if (status.hasUrl) {
                    // Try to get the spreadsheet URL from the last response
                    // For demo purposes, we'll open the GAS setup page
                    this.log('📊 スプレッドシート確認機能は実装中です', 'warning');
                    this.log('💡 実際の運用時はスプレッドシートが直接開きます', 'info');
                    this.updateStatusDot('viewStatus', 'success');
                } else {
                    this.log('❌ スプレッドシートURLが利用できません', 'error');
                    this.updateStatusDot('viewStatus', 'error');
                }
            }

            async refresh() {
                this.log('🔄 システム状態を更新中...', 'info');
                await this.startInitialization();
            }

            enableButtons() {
                document.getElementById('sendSingleBtn').disabled = false;
                document.getElementById('sendBatchBtn').disabled = false;
            }

            updateConnectionStatus(status) {
                const indicator = document.getElementById('connectionStatus');
                const text = document.getElementById('connectionText');
                
                indicator.className = 'status-dot';
                
                let statusText = '';
                switch (status) {
                    case 'connected':
                        indicator.classList.add('status-success');
                        statusText = '接続済み';
                        break;
                    case 'sending':
                        indicator.classList.add('status-sending');
                        statusText = '送信中...';
                        break;
                    case 'error':
                        indicator.classList.add('status-error');
                        statusText = 'エラー';
                        break;
                    case 'pending':
                    default:
                        indicator.classList.add('status-pending');
                        statusText = '未接続';
                }
                
                text.textContent = statusText;
            }

            updateStatusDot(elementId, status) {
                const dot = document.getElementById(elementId);
                if (dot) {
                    dot.className = 'status-dot status-' + status;
                }
            }

            updateQuickStatus() {
                const status = this.gasIntegration ? this.gasIntegration.getStatus() : {};
                
                document.getElementById('quickStatus1').textContent = status.isEnabled ? '有効' : '無効';
                document.getElementById('quickStatus2').textContent = status.hasUrl ? '設定済み' : '未設定';
                document.getElementById('quickStatus3').textContent = this.stats.total > 0 ? '送信済み' : '待機中';
                
                const rate = this.stats.total > 0 ? (this.stats.success / this.stats.total * 100).toFixed(0) : 0;
                document.getElementById('quickStatus4').textContent = rate + '%';
            }

            updateStatistics() {
                document.getElementById('statTotal').textContent = this.stats.total;
                document.getElementById('statSuccess').textContent = this.stats.success;
                document.getElementById('statError').textContent = this.stats.error;
                
                const rate = this.stats.total > 0 ? (this.stats.success / this.stats.total * 100).toFixed(0) : 0;
                document.getElementById('statRate').textContent = rate + '%';
            }

            generateSampleDataTable() {
                const sampleData = [
                    ['田中太郎（デモ1）', '090-DEMO-1001', '18歳以上です', '日本国籍です', '面接実施予定'],
                    ['佐藤花子（デモ2）', '090-DEMO-1002', '18歳以上です', '日本国籍です', '面接実施予定'],
                    ['鈴木一郎（デモ3）', '090-DEMO-1003', '18歳以上です', '日本国籍です', '面接実施予定']
                ];
                
                const tableBody = document.getElementById('sampleDataTable');
                tableBody.innerHTML = '';
                
                sampleData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = row.map(cell => `<td class="px-4 py-2 text-sm text-gray-900">${cell}</td>`).join('');
                    tableBody.appendChild(tr);
                });
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                this.logOutput.appendChild(logEntry);
                this.logOutput.scrollTop = this.logOutput.scrollHeight;
            }

            clearLog() {
                this.logOutput.innerHTML = '<div class="log-entry log-info">🗑️ ログをクリアしました</div>';
            }

            exportLog() {
                const logs = Array.from(this.logOutput.children).map(entry => entry.textContent).join('\n');
                const blob = new Blob([logs], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `gas-demo-log-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.log('📁 ログをエクスポートしました', 'success');
            }

            openSettings() {
                window.open('gas-setup.html', '_blank');
                this.log('📝 GAS設定ページを新しいタブで開きました', 'info');
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize demo when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new GASDemo();
        });
    </script>
</body>
</html>