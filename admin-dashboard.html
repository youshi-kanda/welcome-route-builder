<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALSOK採用システム - 管理者ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid #3b82f6;
        }
        
        .log-info { @apply bg-blue-50 border-l-blue-400 text-blue-700; }
        .log-success { @apply bg-green-50 border-l-green-400 text-green-700; }
        .log-interview { @apply bg-orange-50 border-l-orange-400 text-orange-700; }
        .log-warning { @apply bg-yellow-50 border-l-yellow-400 text-yellow-700; }
        .log-error { @apply bg-red-50 border-l-red-400 text-red-700; }
        
        .applicant-registered { @apply bg-blue-50 border-l-blue-400; }
        .applicant-interview-started { @apply bg-orange-50 border-l-orange-400; }
        .applicant-interview-completed { @apply bg-green-50 border-l-green-400; }
        
        @keyframes pulse-gentle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .pulse-gentle {
            animation: pulse-gentle 2s infinite;
        }
        
        .qr-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 240px;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- ヘッダー -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-white">🛡️ ALSOK採用システム</h1>
                    <div class="text-blue-200 text-sm">管理者ダッシュボード</div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-blue-200 text-sm" id="last-updated">
                        最終更新: --:--:--
                    </div>
                    <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors">
                        🔄 更新
                    </button>
                    <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg transition-colors">
                        🗑️ リセット
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            
            <!-- 左カラム: 統計とQRコード -->
            <div class="xl:col-span-1 space-y-8">
                
                <!-- 統計カード -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        📊 リアルタイム統計
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stat-card rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">応募者数</p>
                                    <p class="text-2xl font-bold text-blue-600" id="stat-total">0</p>
                                </div>
                                <div class="text-3xl">👥</div>
                            </div>
                        </div>
                        
                        <div class="stat-card rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">SMS送信</p>
                                    <p class="text-2xl font-bold text-green-600" id="stat-sms">0</p>
                                </div>
                                <div class="text-3xl">📱</div>
                            </div>
                        </div>
                        
                        <div class="stat-card rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">面接開始</p>
                                    <p class="text-2xl font-bold text-orange-600" id="stat-interview-started">0</p>
                                </div>
                                <div class="text-3xl">🤖</div>
                            </div>
                        </div>
                        
                        <div class="stat-card rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">面接完了</p>
                                    <p class="text-2xl font-bold text-purple-600" id="stat-interview-completed">0</p>
                                </div>
                                <div class="text-3xl">✅</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- QRコード -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        📱 面接用QRコード
                        <span id="qr-status" class="ml-2 text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">
                            アクティブ
                        </span>
                    </h3>
                    
                    <div class="qr-container" id="qr-container">
                        <div class="flex flex-col items-center">
                            <div class="animate-spin w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mb-2"></div>
                            <p class="text-gray-500 text-sm">QRコード生成中...</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-600 break-all">
                            <span class="font-medium">URL:</span>
                            <span id="qr-url">生成中...</span>
                        </p>
                    </div>
                    
                    <button onclick="regenerateQR()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
                        🔄 QRコード再生成
                    </button>
                </div>
            </div>
            
            <!-- 右カラム: 応募者一覧とログ -->
            <div class="xl:col-span-2 space-y-8">
                
                <!-- 応募者一覧 -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            👥 応募者一覧 
                            <span id="applicant-count" class="ml-2 text-sm px-2 py-1 bg-blue-100 text-blue-800 rounded-full">
                                0人
                            </span>
                        </h3>
                        <div class="text-sm text-gray-600">
                            <span id="active-interviews" class="text-orange-600 font-medium">面接中: 0人</span>
                            <span class="mx-2">|</span>
                            <span id="completed-interviews" class="text-green-600 font-medium">完了: 0人</span>
                        </div>
                    </div>
                    
                    <div id="applicants-container" class="space-y-3">
                        <!-- 応募者がいない場合 -->
                        <div id="no-applicants" class="text-center py-12">
                            <div class="text-6xl mb-4 opacity-50">📋</div>
                            <p class="text-gray-500 text-lg">応募者はまだいません</p>
                            <p class="text-gray-400 text-sm mt-2">
                                QRコードをスキャンして面接を開始すると、<br>
                                ここに応募者情報が表示されます
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- システムログ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-800">📝 システムログ</h3>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-400 rounded-full pulse-gentle mr-2"></div>
                                <span class="text-xs text-gray-600">リアルタイム</span>
                            </div>
                            <button onclick="clearLogs()" class="text-xs text-gray-500 hover:text-red-600 transition-colors">
                                ログクリア
                            </button>
                        </div>
                    </div>
                    
                    <div id="system-logs" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            システム待機中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 共有ストレージライブラリ -->
    <script src="shared-storage.js"></script>
    
    <script>
        let updateInterval;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            generateQRCode();
            startAutoUpdate();
        });
        
        // ダッシュボード初期化
        function initializeDashboard() {
            // データ更新イベントリスナー
            window.alsokStorage.onUpdate(handleDataUpdate);
            
            // 初期データ読み込み
            updateDashboard();
            
            // 初期ログ
            window.alsokStorage.addLog('システム起動', '管理者ダッシュボードが起動しました', 'info');
        }
        
        // データ更新ハンドラ
        function handleDataUpdate(event) {
            updateDashboard();
        }
        
        // ダッシュボード更新
        function updateDashboard() {
            updateStats();
            updateApplicantsList();
            updateSystemLogs();
            updateLastUpdated();
        }
        
        // 統計更新
        function updateStats() {
            const stats = window.alsokStorage.getStats();
            
            document.getElementById('stat-total').textContent = stats.totalApplicants;
            document.getElementById('stat-sms').textContent = stats.smsSent;
            document.getElementById('stat-interview-started').textContent = stats.interviewsStarted;
            document.getElementById('stat-interview-completed').textContent = stats.interviewsCompleted;
            
            // 応募者カウント更新
            document.getElementById('applicant-count').textContent = `${stats.totalApplicants}人`;
            document.getElementById('active-interviews').textContent = `面接中: ${stats.interviewsStarted - stats.interviewsCompleted}人`;
            document.getElementById('completed-interviews').textContent = `完了: ${stats.interviewsCompleted}人`;
        }
        
        // 応募者一覧更新
        function updateApplicantsList() {
            const applicants = window.alsokStorage.getAllApplicants();
            const container = document.getElementById('applicants-container');
            const noApplicants = document.getElementById('no-applicants');
            
            if (applicants.length === 0) {
                noApplicants.classList.remove('hidden');
                container.innerHTML = '';
                container.appendChild(noApplicants);
                return;
            }
            
            noApplicants.classList.add('hidden');
            
            container.innerHTML = applicants.map(applicant => {
                const statusInfo = getStatusInfo(applicant.status);
                const progressInfo = getProgressInfo(applicant);
                
                return `
                    <div class="applicant-${applicant.status} border-l-4 rounded-lg p-4 bg-white border">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h4 class="font-semibold text-gray-800">${applicant.name}</h4>
                                    <span class="px-2 py-1 text-xs rounded-full ${statusInfo.class}">
                                        ${statusInfo.text}
                                    </span>
                                </div>
                                
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p>📱 ${applicant.phone}</p>
                                    <p>🆔 ${applicant.id}</p>
                                    <p>⏰ 登録: ${formatDateTime(applicant.createdAt)}</p>
                                    ${applicant.interviewStartedAt ? `<p>🤖 面接開始: ${formatDateTime(applicant.interviewStartedAt)}</p>` : ''}
                                    ${applicant.interviewCompletedAt ? `<p>✅ 面接完了: ${formatDateTime(applicant.interviewCompletedAt)}</p>` : ''}
                                </div>
                            </div>
                            
                            <div class="text-right ml-4">
                                <div class="text-sm text-gray-600 mb-2">
                                    ${progressInfo}
                                </div>
                                ${applicant.responses.length > 0 ? `
                                    <button onclick="showApplicantDetails('${applicant.id}')" 
                                            class="text-xs text-blue-600 hover:text-blue-800 transition-colors">
                                        回答詳細を見る
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ステータス情報取得
        function getStatusInfo(status) {
            switch (status) {
                case 'registered':
                    return { text: '登録済み', class: 'bg-blue-100 text-blue-800' };
                case 'interview_started':
                    return { text: '面接中', class: 'bg-orange-100 text-orange-800' };
                case 'interview_completed':
                    return { text: '面接完了', class: 'bg-green-100 text-green-800' };
                default:
                    return { text: '不明', class: 'bg-gray-100 text-gray-800' };
            }
        }
        
        // 進行情報取得
        function getProgressInfo(applicant) {
            if (applicant.status === 'registered') {
                return '面接待ち';
            } else if (applicant.status === 'interview_started') {
                return `${applicant.responses.length}/5 問回答済み`;
            } else if (applicant.status === 'interview_completed') {
                return `全${applicant.responses.length}問完了`;
            }
            return '';
        }
        
        // システムログ更新
        function updateSystemLogs() {
            const logs = window.alsokStorage.getSystemLogs(15);
            const container = document.getElementById('system-logs');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">ログはまだありません</div>';
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="log-${log.category} border-l-4 p-3 rounded-r text-sm">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <span class="font-medium">${log.type}</span>
                            <span class="ml-2">${log.message}</span>
                        </div>
                        <div class="text-xs opacity-75 ml-4">
                            ${formatTime(log.timestamp)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // QRコード生成
        function generateQRCode() {
            const mobileUrl = `${window.location.origin}/mobile`;
            document.getElementById('qr-url').textContent = mobileUrl;
            
            const container = document.getElementById('qr-container');
            container.innerHTML = '<canvas id="qr-canvas"></canvas>';
            
            QRCode.toCanvas(document.getElementById('qr-canvas'), mobileUrl, {
                width: 200,
                height: 200,
                margin: 2,
                color: {
                    dark: '#1e40af',
                    light: '#ffffff'
                }
            }, function (error) {
                if (error) {
                    console.error('QRコード生成エラー:', error);
                    container.innerHTML = `
                        <div class="text-center text-red-600">
                            <div class="text-4xl mb-2">⚠️</div>
                            <p class="text-sm">QRコード生成に失敗しました</p>
                        </div>
                    `;
                } else {
                    window.alsokStorage.addLog('QRコード生成', '面接用QRコードを生成しました', 'success');
                }
            });
        }
        
        // 最終更新時刻更新
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').textContent = 
                `最終更新: ${now.toLocaleTimeString('ja-JP')}`;
        }
        
        // 自動更新開始
        function startAutoUpdate() {
            updateInterval = setInterval(() => {
                window.alsokStorage.updateStats();
                updateLastUpdated();
            }, 5000);
        }
        
        // 日時フォーマット
        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('ja-JP', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // ユーザーアクション
        function refreshData() {
            window.alsokStorage.updateStats();
            updateDashboard();
            window.alsokStorage.addLog('手動更新', 'ダッシュボードを手動で更新しました', 'info');
        }
        
        function regenerateQR() {
            generateQRCode();
        }
        
        function clearAllData() {
            if (confirm('すべてのデモデータを削除しますか？この操作は取り消せません。')) {
                window.alsokStorage.clearAll();
                updateDashboard();
            }
        }
        
        function clearLogs() {
            if (confirm('システムログをクリアしますか？')) {
                const data = window.alsokStorage.getData();
                data.systemLogs = [];
                window.alsokStorage.saveData(data);
                window.alsokStorage.addLog('ログクリア', 'システムログをクリアしました', 'warning');
            }
        }
        
        function showApplicantDetails(applicantId) {
            const applicant = window.alsokStorage.getApplicant(applicantId);
            if (!applicant) return;
            
            const responses = applicant.responses.map((r, i) => 
                `Q${i+1}: ${r.question}\\nA${i+1}: ${r.answer}\\n`
            ).join('\\n');
            
            alert(`応募者詳細 - ${applicant.name}\\n\\n${responses}`);
        }
        
        // クリーンアップ
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>