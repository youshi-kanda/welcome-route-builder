<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALSOK採用システム - 管理者ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid #3b82f6;
        }
        
        .log-info { @apply bg-blue-50 border-l-blue-400 text-blue-700; }
        .log-success { @apply bg-green-50 border-l-green-400 text-green-700; }
        .log-interview { @apply bg-orange-50 border-l-orange-400 text-orange-700; }
        .log-warning { @apply bg-yellow-50 border-l-yellow-400 text-yellow-700; }
        .log-error { @apply bg-red-50 border-l-red-400 text-red-700; }
        
        .applicant-registered { @apply bg-blue-50 border-l-blue-400; }
        .applicant-interview-started { @apply bg-orange-50 border-l-orange-400; }
        .applicant-interview-completed { @apply bg-green-50 border-l-green-400; }
        
        @keyframes pulse-gentle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .pulse-gentle {
            animation: pulse-gentle 2s infinite;
        }
        
        .qr-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 240px;
        }
        
        /* タブスタイル */
        .tab-button {
            border-bottom-color: transparent;
            color: #6b7280;
        }
        
        .tab-button:hover {
            color: #374151;
            border-bottom-color: #d1d5db;
        }
        
        .tab-button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* データ管理専用スタイル */
        .csv-preview {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            overflow-x: auto;
            overflow-y: auto;
            white-space: nowrap;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #ffffff;
            /* スクロールバーのスタイリング */
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }
        
        .csv-preview::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        .csv-preview::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }
        
        .csv-preview::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }
        
        .csv-preview::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        .csv-preview table {
            border-collapse: collapse;
            min-width: max-content; /* テーブルが内容に応じて幅を持つ */
            width: auto; /* 100%から変更 */
        }
        
        .csv-preview th,
        .csv-preview td {
            border: 1px solid #d1d5db;
            padding: 6px 10px; /* パディングを増加 */
            text-align: left;
            white-space: nowrap; /* テキストの改行を防ぐ */
            vertical-align: top;
        }
        
        /* 列ごとの最適な幅設定 */
        .csv-preview th:nth-child(1), /* 応募者ID */
        .csv-preview td:nth-child(1) {
            min-width: 120px;
            width: 120px;
        }
        
        .csv-preview th:nth-child(2), /* 氏名 */
        .csv-preview td:nth-child(2) {
            min-width: 100px;
            width: 100px;
            font-weight: 500;
        }
        
        .csv-preview th:nth-child(3), /* 電話番号 */
        .csv-preview td:nth-child(3) {
            min-width: 120px;
            width: 120px;
        }
        
        .csv-preview th:nth-child(4), /* 応募経路 */
        .csv-preview td:nth-child(4) {
            min-width: 150px;
            width: 150px;
        }
        
        .csv-preview th:nth-child(5), /* 登録日時 */
        .csv-preview th:nth-child(6), /* 事前確認開始 */
        .csv-preview th:nth-child(7), /* 事前確認完了 */
        .csv-preview td:nth-child(5),
        .csv-preview td:nth-child(6),
        .csv-preview td:nth-child(7) {
            min-width: 140px;
            width: 140px;
        }
        
        .csv-preview th:nth-child(8), /* 所要時間 */
        .csv-preview td:nth-child(8) {
            min-width: 80px;
            width: 80px;
            text-align: center;
        }
        
        .csv-preview th:nth-child(9), /* ステータス */
        .csv-preview td:nth-child(9) {
            min-width: 120px;
            width: 120px;
        }
        
        .csv-preview th:nth-child(10), /* 法的適格性 */
        .csv-preview td:nth-child(10) {
            min-width: 100px;
            width: 100px;
        }
        
        /* Q1-Q11の回答列 */
        .csv-preview th:nth-child(n+11):nth-child(-n+21),
        .csv-preview td:nth-child(n+11):nth-child(-n+21) {
            min-width: 200px;
            width: 200px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 管理用列 */
        .csv-preview th:nth-child(n+22),
        .csv-preview td:nth-child(n+22) {
            min-width: 150px;
            width: 150px;
        }
        
        .csv-preview th {
            background-color: #f9fafb;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 2px solid #4f46e5;
            color: #374151;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* 重要列のハイライト */
        .csv-preview th:nth-child(1),
        .csv-preview th:nth-child(2),
        .csv-preview th:nth-child(9),
        .csv-preview th:nth-child(10) {
            background-color: #eff6ff;
            border-bottom-color: #2563eb;
        }
        
        .csv-preview tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .csv-preview .status-completed {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .csv-preview .legal-qualified {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .csv-preview .legal-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- ヘッダー -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-white">🛡️ ALSOK採用システム</h1>
                    <div class="text-blue-200 text-sm">管理者ダッシュボード</div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-blue-200 text-sm" id="last-updated">
                        最終更新: --:--:--
                    </div>
                    <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors">
                        🔄 更新
                    </button>
                    <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg transition-colors">
                        🗑️ リセット
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- タブナビゲーション -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-6">
            <nav class="flex space-x-8">
                <button 
                    id="tab-dashboard" 
                    class="tab-button active py-4 px-1 border-b-2 font-medium text-sm focus:outline-none transition-colors"
                    onclick="switchTab('dashboard')"
                >
                    📱 応募者管理
                </button>
                <button 
                    id="tab-data-management" 
                    class="tab-button py-4 px-1 border-b-2 font-medium text-sm focus:outline-none transition-colors"
                    onclick="switchTab('data-management')"
                >
                    📊 データ管理
                </button>
                <button 
                    id="tab-statistics" 
                    class="tab-button py-4 px-1 border-b-2 font-medium text-sm focus:outline-none transition-colors"
                    onclick="switchTab('statistics')"
                >
                    📈 詳細統計
                </button>
                <button 
                    id="tab-settings" 
                    class="tab-button py-4 px-1 border-b-2 font-medium text-sm focus:outline-none transition-colors"
                    onclick="switchTab('settings')"
                >
                    ⚙️ システム設定
                </button>
            </nav>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- 応募者管理タブ -->
        <div id="content-dashboard" class="tab-content active">
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            
            <!-- 左カラム: 統計とQRコード -->
            <div class="xl:col-span-1 space-y-8">
                
                <!-- 統計カード -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        📊 リアルタイム統計
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stat-card rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">応募者数</p>
                                    <p class="text-2xl font-bold text-blue-600" id="stat-total">0</p>
                                </div>
                                <div class="text-3xl">👥</div>
                            </div>
                        </div>
                        
                        <div class="stat-card rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">SMS送信</p>
                                    <p class="text-2xl font-bold text-green-600" id="stat-sms">0</p>
                                </div>
                                <div class="text-3xl">📱</div>
                            </div>
                        </div>
                        
                        <div class="stat-card rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">面接開始</p>
                                    <p class="text-2xl font-bold text-orange-600" id="stat-interview-started">0</p>
                                </div>
                                <div class="text-3xl">🤖</div>
                            </div>
                        </div>
                        
                        <div class="stat-card rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">面接完了</p>
                                    <p class="text-2xl font-bold text-purple-600" id="stat-interview-completed">0</p>
                                </div>
                                <div class="text-3xl">✅</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- QRコード -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                        📱 面接用QRコード
                        <span id="qr-status" class="ml-2 text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">
                            アクティブ
                        </span>
                    </h3>
                    
                    <div class="qr-container" id="qr-container">
                        <div class="flex flex-col items-center">
                            <div class="animate-spin w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mb-2"></div>
                            <p class="text-gray-500 text-sm">QRコード生成中...</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-600 break-all">
                            <span class="font-medium">URL:</span>
                            <span id="qr-url">生成中...</span>
                        </p>
                    </div>
                    
                    <button onclick="regenerateQR()" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
                        🔄 QRコード再生成
                    </button>
                </div>
            </div>
            
            <!-- 右カラム: 応募者一覧とログ -->
            <div class="xl:col-span-2 space-y-8">
                
                <!-- 応募者一覧 -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            👥 応募者一覧 
                            <span id="applicant-count" class="ml-2 text-sm px-2 py-1 bg-blue-100 text-blue-800 rounded-full">
                                0人
                            </span>
                        </h3>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <span id="active-interviews" class="text-orange-600 font-medium">面接中: 0人</span>
                                <span class="mx-2">|</span>
                                <span id="completed-interviews" class="text-green-600 font-medium">完了: 0人</span>
                            </div>
                            <button 
                                id="export-applicants-csv" 
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors"
                                title="応募者データをCSV出力"
                            >
                                📊 CSV出力
                            </button>
                        </div>
                    </div>
                    
                    <div id="applicants-container" class="space-y-3">
                        <!-- 応募者がいない場合 -->
                        <div id="no-applicants" class="text-center py-12">
                            <div class="text-6xl mb-4 opacity-50">📋</div>
                            <p class="text-gray-500 text-lg">応募者はまだいません</p>
                            <p class="text-gray-400 text-sm mt-2">
                                QRコードをスキャンして面接を開始すると、<br>
                                ここに応募者情報が表示されます
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- システムログ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-800">📝 システムログ</h3>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-400 rounded-full pulse-gentle mr-2"></div>
                                <span class="text-xs text-gray-600">リアルタイム</span>
                            </div>
                            <button onclick="clearLogs()" class="text-xs text-gray-500 hover:text-red-600 transition-colors">
                                ログクリア
                            </button>
                        </div>
                    </div>
                    
                    <div id="system-logs" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            システム待機中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- データ管理タブ -->
        <div id="content-data-management" class="tab-content">
            <div class="space-y-8">
                
                <!-- データ管理統計 -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">事前確認完了</p>
                                <p class="text-2xl font-bold text-green-600" id="data-stat-completed">0</p>
                            </div>
                            <div class="text-3xl">📋</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">法的適格者</p>
                                <p class="text-2xl font-bold text-blue-600" id="data-stat-qualified">0</p>
                            </div>
                            <div class="text-3xl">⚖️</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">完了率</p>
                                <p class="text-2xl font-bold text-purple-600" id="data-stat-rate">0%</p>
                            </div>
                            <div class="text-3xl">📊</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">平均所要時間</p>
                                <p class="text-2xl font-bold text-orange-600" id="data-stat-duration">0分</p>
                            </div>
                            <div class="text-3xl">⏱️</div>
                        </div>
                    </div>
                </div>
                
                <!-- CSV出力・管理セクション -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- CSV出力管理 -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                            📥 データ出力管理
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-medium text-blue-900 mb-2">📊 CSV一括出力</h4>
                                <p class="text-sm text-blue-700 mb-3">
                                    すべての事前確認データをスプレッドシート形式で出力
                                </p>
                                <button 
                                    id="export-all-csv" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors"
                                >
                                    📥 全データCSV出力
                                </button>
                            </div>
                            
                            <div class="p-4 bg-green-50 rounded-lg">
                                <h4 class="font-medium text-green-900 mb-2">📑 テンプレート管理</h4>
                                <p class="text-sm text-green-700 mb-3">
                                    Google Sheets用の空白テンプレートをダウンロード
                                </p>
                                <button 
                                    id="download-template-csv" 
                                    class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors"
                                >
                                    📑 テンプレートダウンロード
                                </button>
                            </div>
                            
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <h4 class="font-medium text-purple-900 mb-2">🎲 サンプルデータ</h4>
                                <p class="text-sm text-purple-700 mb-3">
                                    テスト・デモ用のサンプルデータを生成
                                </p>
                                <button 
                                    id="generate-sample-csv" 
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition-colors"
                                >
                                    🎲 サンプルデータ生成
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 応募経路分析 -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center">
                            📈 応募経路分析
                        </h3>
                        
                        <div id="application-sources-chart" class="space-y-3">
                            <!-- 動的に生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- CSVプレビュー -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold text-gray-800">📄 データプレビュー</h3>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2">
                                <div class="hidden md:block text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                                    💡 Shift + マウスホイールで横スクロール
                                </div>
                                <span id="preview-count" class="text-sm text-gray-600 px-3 py-1 bg-blue-50 rounded">
                                    0件のデータ
                                </span>
                            </div>
                            <button 
                                id="refresh-csv-preview" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors"
                            >
                                🔄 更新
                            </button>
                        </div>
                    </div>
                    
                    <div id="csv-preview-data" class="csv-preview bg-gray-50 rounded-lg p-4 max-h-96 overflow-auto">
                        <!-- CSVプレビューが動的に生成されます -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 詳細統計タブ -->
        <div id="content-statistics" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-6">📈 詳細統計分析</h3>
                <div class="text-center py-12 text-gray-500">
                    <div class="text-4xl mb-4">📊</div>
                    <p>詳細統計機能は開発中です</p>
                </div>
            </div>
        </div>

        <!-- システム設定タブ -->
        <div id="content-settings" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-6">⚙️ システム設定</h3>
                <div class="text-center py-12 text-gray-500">
                    <div class="text-4xl mb-4">⚙️</div>
                    <p>システム設定機能は開発中です</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 共有ストレージライブラリ -->
    <script src="shared-storage.js"></script>
    <!-- CSV出力ライブラリ -->
    <script src="/scripts/csv-export.js"></script>
    <!-- サンプルデータ生成ライブラリ -->
    <script src="/scripts/sample-data-generator.js"></script>
    
    <script>
        let updateInterval;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            generateQRCode();
            startAutoUpdate();
        });
        
        // ダッシュボード初期化
        function initializeDashboard() {
            // データ更新イベントリスナー
            window.alsokStorage.onUpdate(handleDataUpdate);
            
            // 初期データ読み込み
            updateDashboard();
            
            // 応募者リストCSV出力イベント
            setupApplicantListEvents();
            
            // 初期ログ
            window.alsokStorage.addLog('システム起動', '管理者ダッシュボードが起動しました', 'info');
        }
        
        // 応募者リストイベント設定
        function setupApplicantListEvents() {
            const exportButton = document.getElementById('export-applicants-csv');
            if (exportButton && !exportButton.hasAttribute('data-event-set')) {
                exportButton.addEventListener('click', function() {
                    if (window.alsokCSVExporter) {
                        const success = window.alsokCSVExporter.exportAllApplicants();
                        if (success) {
                            const originalText = this.textContent;
                            this.textContent = '✅ 完了！';
                            this.disabled = true;
                            
                            setTimeout(() => {
                                this.textContent = originalText;
                                this.disabled = false;
                            }, 2000);
                        }
                    }
                });
                exportButton.setAttribute('data-event-set', 'true');
            }
        }
        
        // データ更新ハンドラ
        function handleDataUpdate(event) {
            updateDashboard();
        }
        
        // ダッシュボード更新
        function updateDashboard() {
            updateStats();
            updateApplicantsList();
            updateSystemLogs();
            updateLastUpdated();
        }
        
        // 統計更新
        function updateStats() {
            const stats = window.alsokStorage.getStats();
            
            document.getElementById('stat-total').textContent = stats.totalApplicants;
            document.getElementById('stat-sms').textContent = stats.smsSent;
            document.getElementById('stat-interview-started').textContent = stats.interviewsStarted;
            document.getElementById('stat-interview-completed').textContent = stats.interviewsCompleted;
            
            // 応募者カウント更新
            document.getElementById('applicant-count').textContent = `${stats.totalApplicants}人`;
            document.getElementById('active-interviews').textContent = `面接中: ${stats.interviewsStarted - stats.interviewsCompleted}人`;
            document.getElementById('completed-interviews').textContent = `完了: ${stats.interviewsCompleted}人`;
        }
        
        // 応募者一覧更新
        function updateApplicantsList() {
            const applicants = window.alsokStorage.getAllApplicants();
            const container = document.getElementById('applicants-container');
            const noApplicants = document.getElementById('no-applicants');
            
            if (applicants.length === 0) {
                noApplicants.classList.remove('hidden');
                container.innerHTML = '';
                container.appendChild(noApplicants);
                return;
            }
            
            noApplicants.classList.add('hidden');
            
            container.innerHTML = applicants.map(applicant => {
                const statusInfo = getStatusInfo(applicant.status);
                const progressInfo = getProgressInfo(applicant);
                
                return `
                    <div class="applicant-${applicant.status} border-l-4 rounded-lg p-4 bg-white border">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h4 class="font-semibold text-gray-800">${applicant.name}</h4>
                                    <span class="px-2 py-1 text-xs rounded-full ${statusInfo.class}">
                                        ${statusInfo.text}
                                    </span>
                                </div>
                                
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p>📱 ${applicant.phone}</p>
                                    <p>🆔 ${applicant.id}</p>
                                    <p>⏰ 登録: ${formatDateTime(applicant.createdAt)}</p>
                                    ${applicant.interviewStartedAt ? `<p>🤖 面接開始: ${formatDateTime(applicant.interviewStartedAt)}</p>` : ''}
                                    ${applicant.interviewCompletedAt ? `<p>✅ 面接完了: ${formatDateTime(applicant.interviewCompletedAt)}</p>` : ''}
                                </div>
                            </div>
                            
                            <div class="text-right ml-4">
                                <div class="text-sm text-gray-600 mb-2">
                                    ${progressInfo}
                                </div>
                                <div class="space-y-1">
                                    ${applicant.responses.length > 0 ? `
                                        <button onclick="showApplicantDetails('${applicant.id}')" 
                                                class="block text-xs text-blue-600 hover:text-blue-800 transition-colors">
                                            回答詳細を見る
                                        </button>
                                    ` : ''}
                                    ${applicant.screeningResponses && applicant.screeningResponses.length > 0 ? `
                                        <button onclick="exportApplicantCSV('${applicant.id}')" 
                                                class="block text-xs text-green-600 hover:text-green-800 transition-colors">
                                            📊 CSV出力
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ステータス情報取得
        function getStatusInfo(status) {
            switch (status) {
                case 'registered':
                    return { text: '登録済み', class: 'bg-blue-100 text-blue-800' };
                case 'interview_started':
                    return { text: '面接中', class: 'bg-orange-100 text-orange-800' };
                case 'interview_completed':
                    return { text: '面接完了', class: 'bg-green-100 text-green-800' };
                default:
                    return { text: '不明', class: 'bg-gray-100 text-gray-800' };
            }
        }
        
        // 進行情報取得
        function getProgressInfo(applicant) {
            if (applicant.status === 'registered') {
                return '面接待ち';
            } else if (applicant.status === 'interview_started') {
                return `${applicant.responses.length}/5 問回答済み`;
            } else if (applicant.status === 'interview_completed') {
                return `全${applicant.responses.length}問完了`;
            }
            return '';
        }
        
        // システムログ更新
        function updateSystemLogs() {
            const logs = window.alsokStorage.getSystemLogs(15);
            const container = document.getElementById('system-logs');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">ログはまだありません</div>';
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="log-${log.category} border-l-4 p-3 rounded-r text-sm">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <span class="font-medium">${log.type}</span>
                            <span class="ml-2">${log.message}</span>
                        </div>
                        <div class="text-xs opacity-75 ml-4">
                            ${formatTime(log.timestamp)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // QRコード生成
        function generateQRCode() {
            const mobileUrl = `${window.location.origin}/mobile`;
            document.getElementById('qr-url').textContent = mobileUrl;
            
            const container = document.getElementById('qr-container');
            container.innerHTML = '<canvas id="qr-canvas"></canvas>';
            
            QRCode.toCanvas(document.getElementById('qr-canvas'), mobileUrl, {
                width: 200,
                height: 200,
                margin: 2,
                color: {
                    dark: '#1e40af',
                    light: '#ffffff'
                }
            }, function (error) {
                if (error) {
                    console.error('QRコード生成エラー:', error);
                    container.innerHTML = `
                        <div class="text-center text-red-600">
                            <div class="text-4xl mb-2">⚠️</div>
                            <p class="text-sm">QRコード生成に失敗しました</p>
                        </div>
                    `;
                } else {
                    window.alsokStorage.addLog('QRコード生成', '面接用QRコードを生成しました', 'success');
                }
            });
        }
        
        // 最終更新時刻更新
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').textContent = 
                `最終更新: ${now.toLocaleTimeString('ja-JP')}`;
        }
        
        // 自動更新開始
        function startAutoUpdate() {
            updateInterval = setInterval(() => {
                window.alsokStorage.updateStats();
                updateLastUpdated();
            }, 5000);
        }
        
        // 日時フォーマット
        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('ja-JP', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatTime(dateString) {
            return new Date(dateString).toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // ユーザーアクション
        function refreshData() {
            window.alsokStorage.updateStats();
            updateDashboard();
            window.alsokStorage.addLog('手動更新', 'ダッシュボードを手動で更新しました', 'info');
        }
        
        function regenerateQR() {
            generateQRCode();
        }
        
        function clearAllData() {
            if (confirm('すべてのデモデータを削除しますか？この操作は取り消せません。')) {
                window.alsokStorage.clearAll();
                updateDashboard();
            }
        }
        
        function clearLogs() {
            if (confirm('システムログをクリアしますか？')) {
                const data = window.alsokStorage.getData();
                data.systemLogs = [];
                window.alsokStorage.saveData(data);
                window.alsokStorage.addLog('ログクリア', 'システムログをクリアしました', 'warning');
            }
        }
        
        function showApplicantDetails(applicantId) {
            const applicant = window.alsokStorage.getApplicant(applicantId);
            if (!applicant) return;
            
            const responses = applicant.responses.map((r, i) => 
                `Q${i+1}: ${r.question}\\nA${i+1}: ${r.answer}\\n`
            ).join('\\n');
            
            alert(`応募者詳細 - ${applicant.name}\\n\\n${responses}`);
        }
        
        // 個別応募者CSV出力
        function exportApplicantCSV(applicantId) {
            if (window.alsokCSVExporter) {
                const success = window.alsokCSVExporter.exportSingleApplicant(applicantId);
                if (success) {
                    // 成功メッセージを短時間表示
                    const applicant = window.alsokStorage.getApplicant(applicantId);
                    window.alsokStorage.addLog('CSV出力', `${applicant.name}のデータをCSV出力しました`, 'success');
                }
            }
        }
        
        // タブ切り替え機能
        function switchTab(tabName) {
            // すべてのタブボタンとコンテンツを非アクティブに
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 選択されたタブをアクティブに
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`content-${tabName}`).classList.add('active');
            
            // タブ固有の初期化
            if (tabName === 'data-management') {
                initializeDataManagement();
            }
        }
        
        // データ管理タブ初期化
        function initializeDataManagement() {
            updateDataManagementStats();
            updateApplicationSourcesChart();
            updateCSVPreview();
            setupDataManagementEvents();
        }
        
        // データ管理統計更新
        function updateDataManagementStats() {
            const applicants = window.alsokStorage.getAllApplicants();
            const completedApplicants = applicants.filter(a => 
                a.screeningResponses && a.screeningResponses.length > 0
            );
            const qualifiedApplicants = completedApplicants.filter(a => a.isQualified);
            
            // 完了率計算
            const completionRate = applicants.length > 0 ? 
                Math.round((completedApplicants.length / applicants.length) * 100) : 0;
            
            // 平均所要時間計算
            let avgDuration = 0;
            if (completedApplicants.length > 0) {
                const totalDuration = completedApplicants.reduce((sum, a) => {
                    if (a.screeningStartedAt && a.screeningCompletedAt) {
                        const start = new Date(a.screeningStartedAt);
                        const end = new Date(a.screeningCompletedAt);
                        return sum + Math.ceil((end - start) / (1000 * 60));
                    }
                    return sum;
                }, 0);
                avgDuration = Math.round(totalDuration / completedApplicants.length);
            }
            
            // 統計表示更新
            document.getElementById('data-stat-completed').textContent = completedApplicants.length;
            document.getElementById('data-stat-qualified').textContent = qualifiedApplicants.length;
            document.getElementById('data-stat-rate').textContent = `${completionRate}%`;
            document.getElementById('data-stat-duration').textContent = `${avgDuration}分`;
        }
        
        // 応募経路チャート更新
        function updateApplicationSourcesChart() {
            const applicants = window.alsokStorage.getAllApplicants();
            const completedApplicants = applicants.filter(a => 
                a.screeningResponses && a.screeningResponses.length > 0
            );
            
            const sourceMapping = {
                1: 'お電話でのお問い合わせ',
                2: 'Indeed（インディード）',
                3: 'ハローワーク',
                4: '弊社ホームページ',
                5: 'SNS（Instagram、Twitter等）',
                6: '求人誌・フリーペーパー',
                7: '知人からの紹介',
                8: 'その他'
            };
            
            const sourceCounts = {};
            completedApplicants.forEach(applicant => {
                const source = sourceMapping[applicant.applicationSource] || 'その他';
                sourceCounts[source] = (sourceCounts[source] || 0) + 1;
            });
            
            const container = document.getElementById('application-sources-chart');
            
            if (Object.keys(sourceCounts).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-4">📊</div>
                        <p>応募データがまだありません</p>
                    </div>
                `;
                return;
            }
            
            const total = Object.values(sourceCounts).reduce((sum, count) => sum + count, 0);
            
            container.innerHTML = Object.entries(sourceCounts).map(([source, count]) => {
                const percentage = Math.round((count / total) * 100);
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">${source}</div>
                            <div class="text-xs text-gray-600">${count}件 (${percentage}%)</div>
                        </div>
                        <div class="w-24 bg-gray-200 rounded-full h-2 ml-4">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // CSVプレビュー更新
        function updateCSVPreview() {
            const applicants = window.alsokStorage.getAllApplicants();
            const completedApplicants = applicants.filter(a => 
                a.screeningResponses && a.screeningResponses.length > 0
            );
            
            const container = document.getElementById('csv-preview-data');
            const countElement = document.getElementById('preview-count');
            
            countElement.textContent = `${completedApplicants.length}件のデータ`;
            
            if (completedApplicants.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-4">📋</div>
                        <div>事前確認を完了した応募者がいません</div>
                        <button onclick="generateSampleDataForManagement()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg">
                            サンプルデータを生成
                        </button>
                    </div>
                `;
                return;
            }
            
            // CSVデータ生成（全データ表示、最初の5行）
            const previewApplicants = completedApplicants.slice(0, 5);
            const csvRows = [];
            const headers = window.alsokCSVExporter.csvHeaders;
            csvRows.push(headers);
            
            previewApplicants.forEach(applicant => {
                csvRows.push(window.alsokCSVExporter.convertApplicantToCSVRow(applicant));
            });
            
            // テーブル生成（全列表示）
            const tableHTML = `
                <div class="mb-4 flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        📊 全${headers.length}列のデータを表示中
                    </div>
                    <div class="text-xs text-blue-600">
                        💡 横スクロールで全データが確認できます
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>${headers.map((header, index) => `
                            <th title="${header}">
                                ${header}
                            </th>
                        `).join('')}</tr>
                    </thead>
                    <tbody>
                        ${csvRows.slice(1).map(row => `
                            <tr>
                                ${row.map((cell, index) => {
                                    const header = headers[index];
                                    let classes = '';
                                    
                                    // 条件付きスタイリング
                                    if (header === 'ステータス' && cell === '事前確認完了') {
                                        classes += 'status-completed';
                                    }
                                    if (header === '法的適格性') {
                                        if (cell === '適格') {
                                            classes += 'legal-qualified';
                                        } else if (cell && cell.includes('要注意')) {
                                            classes += 'legal-warning';
                                        }
                                    }
                                    
                                    // セルの内容が長い場合のツールチップ
                                    const displayCell = cell || '-';
                                    const cellTitle = displayCell.length > 50 ? displayCell : '';
                                    
                                    return `<td class="${classes}" title="${cellTitle}">${displayCell}</td>`;
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${completedApplicants.length > 5 ? `
                    <div class="text-center mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="text-sm text-blue-700 font-medium">
                            📋 表示: ${previewApplicants.length}件 / 全${completedApplicants.length}件
                        </div>
                        <div class="text-xs text-blue-600 mt-1">
                            すべてのデータを確認するにはCSV出力をご利用ください
                        </div>
                    </div>
                ` : ''}
            `;
            
            container.innerHTML = tableHTML;
        }
        
        // データ管理イベント設定
        function setupDataManagementEvents() {
            // 一度だけ設定されるように確認
            if (document.getElementById('export-all-csv').hasAttribute('data-event-set')) {
                return;
            }
            
            // CSVプレビュー用の横スクロール改善機能を追加
            setupCSVPreviewEnhancements();
            
            // CSV出力
            document.getElementById('export-all-csv').addEventListener('click', function() {
                if (window.alsokCSVExporter) {
                    const success = window.alsokCSVExporter.exportAllApplicants();
                    if (success) {
                        showDataActionFeedback(this, '✅ ダウンロード完了！');
                    }
                }
            });
            
            // テンプレートダウンロード
            document.getElementById('download-template-csv').addEventListener('click', function() {
                downloadCSVTemplate();
                showDataActionFeedback(this, '✅ ダウンロード完了！');
            });
            
            // サンプルデータ生成
            document.getElementById('generate-sample-csv').addEventListener('click', function() {
                generateSampleDataForManagement();
                showDataActionFeedback(this, '✅ 生成完了！');
            });
            
            // プレビュー更新
            document.getElementById('refresh-csv-preview').addEventListener('click', function() {
                updateCSVPreview();
                updateDataManagementStats();
                updateApplicationSourcesChart();
                showDataActionFeedback(this, '✅ 更新完了！');
            });
            
            // イベント設定済みマーク
            document.getElementById('export-all-csv').setAttribute('data-event-set', 'true');
        }
        
        // アクションフィードバック表示
        function showDataActionFeedback(button, message) {
            const originalText = button.textContent;
            button.textContent = message;
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        }
        
        // CSVテンプレートダウンロード
        function downloadCSVTemplate() {
            const headers = window.alsokCSVExporter.csvHeaders;
            const templateContent = headers.join(',') + '\r\n';
            
            const bom = '\uFEFF';
            const blob = new Blob([bom + templateContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'ALSOK採用管理テンプレート.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }
        
        // 管理画面用サンプルデータ生成
        function generateSampleDataForManagement() {
            if (window.alsokSampleGenerator) {
                window.alsokSampleGenerator.addSampleDataToStorage(5);
                
                // UI更新
                setTimeout(() => {
                    updateDataManagementStats();
                    updateApplicationSourcesChart();
                    updateCSVPreview();
                    updateDashboard(); // メイン統計も更新
                }, 500);
            }
        }
        
        // CSVプレビュー改善機能
        function setupCSVPreviewEnhancements() {
            const previewContainer = document.getElementById('csv-preview-data');
            
            // Shift + マウスホイールによる横スクロール
            previewContainer.addEventListener('wheel', function(e) {
                if (e.shiftKey) {
                    e.preventDefault();
                    this.scrollLeft += e.deltaY;
                }
            });
            
            // タッチデバイス用のスワイプサポート
            let isScrolling = false;
            let startX = 0;
            
            previewContainer.addEventListener('touchstart', function(e) {
                startX = e.touches[0].pageX;
                isScrolling = false;
            });
            
            previewContainer.addEventListener('touchmove', function(e) {
                if (!isScrolling) {
                    const currentX = e.touches[0].pageX;
                    const diffX = startX - currentX;
                    
                    if (Math.abs(diffX) > 10) { // 10px以上の移動で横スクロール開始
                        isScrolling = true;
                        this.scrollLeft += diffX * 2; // スクロール感度調整
                        startX = currentX;
                        e.preventDefault();
                    }
                }
            });
            
            // スクロール位置インジケーター
            previewContainer.addEventListener('scroll', function() {
                showScrollIndicator(this);
            });
        }
        
        // スクロール位置インジケーター表示
        function showScrollIndicator(container) {
            // 既存のインジケーターを削除
            const existingIndicator = container.querySelector('.scroll-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // スクロール可能かチェック
            if (container.scrollWidth <= container.clientWidth) {
                return; // スクロールの必要がない場合は表示しない
            }
            
            // インジケーター作成
            const indicator = document.createElement('div');
            indicator.className = 'scroll-indicator';
            indicator.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(59, 130, 246, 0.9);
                color: white;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 10px;
                pointer-events: none;
                z-index: 30;
                transition: opacity 0.3s ease;
            `;
            
            // スクロール位置計算
            const scrollPercentage = Math.round((container.scrollLeft / (container.scrollWidth - container.clientWidth)) * 100);
            indicator.textContent = `${scrollPercentage}% →`;
            
            // 相対positioned親要素に追加
            container.style.position = 'relative';
            container.appendChild(indicator);
            
            // 2秒後に自動消去
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.style.opacity = '0';
                    setTimeout(() => {
                        if (indicator.parentNode) {
                            indicator.remove();
                        }
                    }, 300);
                }
            }, 2000);
        }
        
        // クリーンアップ
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>