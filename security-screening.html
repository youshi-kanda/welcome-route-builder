<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ALSOKäº‹å‰ç²¾æŸ» - æ¡ç”¨æ‹…å½“ãƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        .chat-container {
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-bottom: 10px;
            flex-grow: 1;
            max-height: calc(100vh - 220px);
        }
        
        .message-ai {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
        }
        
        .message-user {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .choice-button {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .choice-button:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }
        
        .choice-button.selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #059669;
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .warning-alert {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        
        .disqualified-alert {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            border-left: 4px solid #ef4444;
        }
        
        .qualified-alert {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .chat-container::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 2px;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .chat-container {
                max-height: calc(100vh - 250px);
            }
            
            #choices-container {
                max-height: 35vh !important;
            }
            
            #response-area {
                max-height: 45vh !important;
            }
        }
        
        @media (max-width: 480px) {
            .chat-container {
                max-height: calc(100vh - 280px);
            }
            
            #choices-container {
                max-height: 30vh !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col h-screen">
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="gradient-bg shadow-lg">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="ai-avatar w-10 h-10 rounded-full flex items-center justify-center text-white text-lg">
                        ğŸ‘¤
                    </div>
                    <div>
                        <h1 class="text-white font-semibold">ALSOKæ¡ç”¨æ‹…å½“è€…</h1>
                        <p class="text-blue-200 text-sm" id="screening-status">äº‹å‰ç²¾æŸ»å®Ÿæ–½ä¸­</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-white text-sm">ã‚¹ãƒ†ãƒƒãƒ— <span id="step-counter">1</span>/5</div>
                    <div class="text-blue-200 text-xs" id="applicant-name">---</div>
                </div>
            </div>
            
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
            <div class="mt-3 bg-blue-900 bg-opacity-50 rounded-full h-2">
                <div id="progress-bar" class="progress-bar bg-white h-2 rounded-full" style="width: 20%"></div>
            </div>
        </div>
    </header>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <main class="chat-container px-4 py-4 flex-1" id="chat-container">
        
        <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="message-ai rounded-2xl p-4 mb-4 fade-in">
            <div class="flex items-start space-x-3">
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                    ğŸ‘¤
                </div>
                <div>
                    <div class="font-medium text-gray-800 mb-1">ALSOKæ¡ç”¨æ‹…å½“è€…</div>
                    <div class="text-gray-700 leading-relaxed">
                        ã“ã®åº¦ã¯å¼Šç¤¾è­¦å‚™å“¡æ±‚äººã«ã”å¿œå‹Ÿã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸŒŸ<br><br>
                        é¢æ¥å‰ã«å¿…è¦ãªç¢ºèªäº‹é …ãŒã”ã–ã„ã¾ã™ã®ã§ã€ã„ãã¤ã‹è³ªå•ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚<br>
                        ï¼ˆæ‰€è¦æ™‚é–“ï¼š5ã€œ8åˆ†ç¨‹åº¦ï¼‰<br><br>
                        ã“ã®ç¢ºèªã«ã‚ˆã‚Šã€ãŠäº’ã„ã«ã¨ã£ã¦ã‚ˆã‚Šè‰¯ã„é¢æ¥ã‚’æº–å‚™ã§ãã¾ã™ã€‚æ­£ç›´ã«ãŠç­”ãˆã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ğŸ˜Š
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å‹•çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        
    </main>

    <!-- å›ç­”ã‚¨ãƒªã‚¢ -->
    <footer class="bg-white bg-opacity-95 backdrop-blur-sm border-t p-3 overflow-y-auto flex-shrink-0" style="max-height: 40vh;" id="response-area">
        
        <!-- é¸æŠè‚¢å›ç­” -->
        <div id="choice-form" class="hidden">
            <div id="choices-container" class="grid grid-cols-1 gap-2 mb-3 overflow-y-auto" style="max-height: 40vh;">
                <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹é¸æŠè‚¢ -->
            </div>
            <div class="text-center">
                <button 
                    id="choice-submit-btn" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    ğŸ“¤ å›ç­”ã‚’é€ä¿¡
                </button>
            </div>
        </div>
        
        <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›å›ç­” -->
        <div id="text-form" class="hidden space-y-3">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-2">
                    ğŸ‘¤
                </div>
                <div class="flex-1">
                    <textarea 
                        id="text-input" 
                        placeholder="ã“ã¡ã‚‰ã«è©³ã—ãã”è¨˜å…¥ãã ã•ã„..."
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none resize-none"
                        rows="3"
                        maxlength="500"
                    ></textarea>
                    <div class="flex items-center justify-between mt-2">
                        <div class="text-xs text-gray-500">
                            <span id="char-count">0</span>/500 æ–‡å­—
                        </div>
                        <button 
                            id="text-submit-btn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            ğŸ“¤ é€ä¿¡
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å‡¦ç†ä¸­çŠ¶æ…‹ -->
        <div id="processing-state" class="hidden text-center py-4">
            <div class="inline-flex items-center space-x-2 bg-blue-100 text-blue-800 px-4 py-2 rounded-lg">
                <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>å›ç­”ã‚’å‡¦ç†ä¸­...</span>
            </div>
        </div>
        
        <!-- ç²¾æŸ»å®Œäº†çŠ¶æ…‹ -->
        <div id="completed-state" class="hidden text-center py-4">
            <div id="completion-message" class="px-4 py-2 rounded-lg inline-block">
                âœ… äº‹å‰ç²¾æŸ»ãŒå®Œäº†ã—ã¾ã—ãŸ
            </div>
        </div>
    </footer>

    <!-- å…±æœ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="shared-storage.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let applicantId = null;
        let currentStep = 0;
        let applicantData = null;
        let isProcessing = false;
        let selectedChoice = null;
        let disqualificationReasons = [];
        
        // ç²¾æŸ»ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©
        const screeningSteps = [
            {
                id: 1,
                type: 'choice',
                question: 'ã¾ãšã€ã©ã¡ã‚‰ã‹ã‚‰å¼Šç¤¾ã®æ±‚äººã‚’ãŠçŸ¥ã‚Šã«ãªã‚Šã¾ã—ãŸã‹ï¼Ÿ',
                choices: [
                    { id: 1, text: '1âƒ£ ãŠé›»è©±ã§ã®ãŠå•ã„åˆã‚ã›' },
                    { id: 2, text: '2âƒ£ Indeedï¼ˆã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼ãƒ‰ï¼‰' },
                    { id: 3, text: '3âƒ£ ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ã‚¯' },
                    { id: 4, text: '4âƒ£ å¼Šç¤¾ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸' },
                    { id: 5, text: '5âƒ£ SNSï¼ˆInstagramã€Twitterç­‰ï¼‰' },
                    { id: 6, text: '6âƒ£ æ±‚äººèªŒãƒ»ãƒ•ãƒªãƒ¼ãƒšãƒ¼ãƒ‘ãƒ¼' },
                    { id: 7, text: '7âƒ£ çŸ¥äººã‹ã‚‰ã®ç´¹ä»‹' },
                    { id: 8, text: '8âƒ£ ãã®ä»–' }
                ],
                instruction: 'ç•ªå·ã§ãŠç­”ãˆãã ã•ã„ã€‚'
            },
            {
                id: 2,
                type: 'choice',
                question: 'è­¦å‚™æ¥­æ³•ã«åŸºã¥ãã€ä»¥ä¸‹ã®äº‹é …ã«ã¤ã„ã¦ç¢ºèªã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚\n\néå»ã«ä»¥ä¸‹ã®ã‚ˆã†ãªçµŒæ­´ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ',
                choices: [
                    { id: 1, text: 'ç¦éŒ®ä»¥ä¸Šã®åˆ‘ã«å‡¦ã›ã‚‰ã‚ŒãŸ' },
                    { id: 2, text: 'è­¦å‚™æ¥­æ³•é•åã«ã‚ˆã‚Šç½°é‡‘åˆ‘ã‚’å—ã‘ãŸ' },
                    { id: 3, text: 'ç²¾ç¥æ©Ÿèƒ½ã®éšœå®³ã«ã‚ˆã‚Šè­¦å‚™æ¥­å‹™ã‚’é©æ­£ã«è¡Œã†ã«å½“ãŸã£ã¦å¿…è¦ãªèªçŸ¥ãƒ»åˆ¤æ–­ãƒ»æ„æ€ç–é€šã‚’é©åˆ‡ã«è¡Œã†ã“ã¨ãŒã§ããªã„' },
                    { id: 4, text: 'ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã€éº»è–¬ã€å¤§éº»ã€ã‚ã¸ã‚“åˆã¯è¦šé†’å‰¤ã®ä¸­æ¯’è€…' },
                    { id: 5, text: 'æš´åŠ›å›£å“¡åˆã¯æš´åŠ›å›£å“¡ã§ãªããªã£ãŸæ—¥ã‹ã‚‰5å¹´ã‚’çµŒéã—ãªã„è€…' },
                    { id: 6, text: 'ä¸Šè¨˜ã®ã„ãšã‚Œã«ã‚‚è©²å½“ã—ãªã„' }
                ],
                instruction: 'è©²å½“ã™ã‚‹ã‚‚ã®ã‚’ã™ã¹ã¦ãŠé¸ã³ãã ã•ã„ã€‚æ­£ç›´ã«ãŠç­”ãˆãã ã•ã„ã€‚',
                multiSelect: true
            },
            {
                id: 3,
                type: 'choice',
                question: 'è­¦å‚™æ¥­å‹™ã¸ã®å–ã‚Šçµ„ã¿å§¿å‹¢ã«ã¤ã„ã¦ãŠèãã—ã¾ã™ã€‚\n\nç¶™ç¶šçš„ã«å‹¤å‹™ã—ã¦ã„ãŸã ãã“ã¨ãŒé‡è¦ã§ã™ãŒã€ã©ã®ãã‚‰ã„ã®æœŸé–“ãŠå‹¤ã‚ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
                choices: [
                    { id: 1, text: '1å¹´ä»¥ä¸Šã®é•·æœŸå‹¤å‹™ã‚’å¸Œæœ›' },
                    { id: 2, text: 'åŠå¹´ã€œ1å¹´ç¨‹åº¦' },
                    { id: 3, text: '3ãƒ¶æœˆã€œåŠå¹´ç¨‹åº¦' },
                    { id: 4, text: 'çŸ­æœŸé–“ï¼ˆæ•°ãƒ¶æœˆä»¥å†…ï¼‰' },
                    { id: 5, text: 'æœªå®šãƒ»çŠ¶æ³ã«ã‚ˆã‚‹' }
                ],
                instruction: 'ã”å¸Œæœ›ã«è¿‘ã„ã‚‚ã®ã‚’ãŠé¸ã³ãã ã•ã„ã€‚'
            },
            {
                id: 4,
                type: 'choice',
                question: 'è­¦å‚™æ¥­å‹™ã®ç‰¹æ€§ä¸Šã€ä½“åŠ›é¢ã§ã®ç¢ºèªã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚\n\nä»¥ä¸‹ã®æ¥­å‹™ã«å¯¾å¿œå¯èƒ½ã§ã—ã‚‡ã†ã‹ï¼Ÿ',
                choices: [
                    { id: 1, text: 'ç«‹ä½æ¥­å‹™ï¼ˆé•·æ™‚é–“ã®ç«‹ã¡ä»•äº‹ï¼‰' },
                    { id: 2, text: 'å·¡å›æ¥­å‹™ï¼ˆæ­©è¡Œãƒ»éšæ®µæ˜‡é™ï¼‰' },
                    { id: 3, text: 'å¤œå‹¤æ¥­å‹™ï¼ˆæ·±å¤œå‹¤å‹™ï¼‰' },
                    { id: 4, text: 'äº¤é€šèª˜å°ï¼ˆå±‹å¤–ä½œæ¥­ï¼‰' },
                    { id: 5, text: 'ä¸Šè¨˜ã™ã¹ã¦å¯¾å¿œå¯èƒ½' },
                    { id: 6, text: 'ä¸€éƒ¨å¯¾å¿œå›°é›£' }
                ],
                instruction: 'å¯¾å¿œå¯èƒ½ãªã‚‚ã®ã‚’ãŠé¸ã³ãã ã•ã„ã€‚',
                multiSelect: true
            },
            {
                id: 5,
                type: 'text',
                question: 'æœ€å¾Œã«ã€è­¦å‚™å“¡ã¨ã—ã¦åƒãä¸Šã§ã®æ„æ°—è¾¼ã¿ã‚„ã€ç‰¹ã«ã‚¢ãƒ”ãƒ¼ãƒ«ã—ãŸã„ã“ã¨ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚',
                instruction: 'ç°¡æ½”ã§æ§‹ã„ã¾ã›ã‚“ã®ã§ã€ã‚ãªãŸã®æ€ã„ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚',
                placeholder: 'ä¾‹ï¼šè²¬ä»»æ„Ÿã‚’æŒã£ã¦åœ°åŸŸã®å®‰å…¨ã«è²¢çŒ®ã—ãŸã„ã€ãªã©...'
            }
        ];
        
        // DOMè¦ç´ 
        const chatContainer = document.getElementById('chat-container');
        const stepCounter = document.getElementById('step-counter');
        const progressBar = document.getElementById('progress-bar');
        const applicantNameEl = document.getElementById('applicant-name');
        const screeningStatus = document.getElementById('screening-status');
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeScreening();
        });
        
        // äº‹å‰ç²¾æŸ»åˆæœŸåŒ–
        function initializeScreening() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å¿œå‹Ÿè€…IDå–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            applicantId = urlParams.get('id');
            
            if (!applicantId) {
                alert('ã‚¨ãƒ©ãƒ¼: å¿œå‹Ÿè€…IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = '/mobile';
                return;
            }
            
            // å¿œå‹Ÿè€…ãƒ‡ãƒ¼ã‚¿å–å¾—
            applicantData = window.alsokStorage.getApplicant(applicantId);
            if (!applicantData) {
                console.error('å¿œå‹Ÿè€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', applicantId);
                alert('ã‚¨ãƒ©ãƒ¼: å¿œå‹Ÿè€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = '/mobile';
                return;
            }
            
            // å¿œå‹Ÿè€…ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯
            if (!applicantData.name) {
                console.error('å¿œå‹Ÿè€…ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™:', applicantData);
                alert('ã‚¨ãƒ©ãƒ¼: å¿œå‹Ÿè€…ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™');
                window.location.href = '/mobile';
                return;
            }
            
            // UIåˆæœŸåŒ–
            applicantNameEl.textContent = applicantData.name;
            
            // ç²¾æŸ»é–‹å§‹çŠ¶æ…‹ã«æ›´æ–°
            window.alsokStorage.updateApplicant(applicantId, {
                status: 'screening',
                screeningStartedAt: new Date().toISOString()
            });
            
            // æœ€åˆã®è³ªå•ã‚’è¡¨ç¤º
            setTimeout(() => {
                showNextStep();
            }, 2000);
        }
        
        // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
        function showNextStep() {
            if (currentStep >= screeningSteps.length) {
                completeScreening();
                return;
            }
            
            const step = screeningSteps[currentStep];
            
            // UIæ›´æ–°
            stepCounter.textContent = step.id;
            progressBar.style.width = `${(step.id / screeningSteps.length) * 100}%`;
            screeningStatus.textContent = `ã‚¹ãƒ†ãƒƒãƒ— ${step.id}`;
            
            // è³ªå•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            setTimeout(() => {
                addAIMessage(step.question, step.instruction);
                showInputForm(step);
                // æ–°ã—ã„è³ªå•ãŒè¿½åŠ ã•ã‚ŒãŸå¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                setTimeout(() => scrollToBottom(), 300);
            }, 1000);
        }
        
        // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addAIMessage(text, instruction = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-ai rounded-2xl p-4 mb-4 fade-in';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                        ğŸ‘¤
                    </div>
                    <div>
                        <div class="font-medium text-gray-800 mb-1">ALSOKæ¡ç”¨æ‹…å½“è€…</div>
                        <div class="text-gray-700 leading-relaxed">
                            ${text.replace(/\n/g, '<br>')}
                        </div>
                        ${instruction ? `
                            <div class="text-xs text-blue-600 mt-3 bg-blue-50 rounded-lg p-2">
                                ğŸ’¡ ${instruction}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-user rounded-2xl p-4 mb-4 fade-in ml-8';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3 justify-end">
                    <div class="text-right">
                        <div class="font-medium text-white mb-1">ã‚ãªãŸã®å›ç­”</div>
                        <div class="text-white leading-relaxed">
                            ${text.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                        ğŸ‘¤
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        function showInputForm(step) {
            hideAllForms();
            
            if (step.type === 'choice') {
                showChoiceForm(step);
            } else if (step.type === 'text') {
                showTextForm(step);
            }
        }
        
        // é¸æŠè‚¢ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        function showChoiceForm(step) {
            const choiceForm = document.getElementById('choice-form');
            const choicesContainer = document.getElementById('choices-container');
            const submitBtn = document.getElementById('choice-submit-btn');
            
            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ç”Ÿæˆ
            choicesContainer.innerHTML = step.choices.map(choice => `
                <button 
                    class="choice-button p-2 rounded-lg text-left text-sm hover:bg-blue-50"
                    data-choice-id="${choice.id}"
                    onclick="selectChoice(${choice.id}, ${step.multiSelect || false})"
                >
                    ${choice.text}
                </button>
            `).join('');
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            submitBtn.onclick = () => submitChoiceAnswer(step);
            
            choiceForm.classList.remove('hidden');
            selectedChoice = step.multiSelect ? [] : null;
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        function showTextForm(step) {
            const textForm = document.getElementById('text-form');
            const textInput = document.getElementById('text-input');
            const charCount = document.getElementById('char-count');
            const submitBtn = document.getElementById('text-submit-btn');
            
            textInput.placeholder = step.placeholder || 'ã“ã¡ã‚‰ã«è©³ã—ãã”è¨˜å…¥ãã ã•ã„...';
            textInput.value = '';
            
            // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
            textInput.oninput = () => {
                const length = textInput.value.trim().length;
                charCount.textContent = length;
                submitBtn.disabled = length === 0;
            };
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            submitBtn.onclick = () => submitTextAnswer(step);
            
            textForm.classList.remove('hidden');
            textInput.focus();
        }
        
        // é¸æŠè‚¢é¸æŠ
        function selectChoice(choiceId, multiSelect = false) {
            const buttons = document.querySelectorAll('.choice-button');
            const clickedButton = document.querySelector(`[data-choice-id="${choiceId}"]`);
            
            if (multiSelect) {
                // è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰
                if (!selectedChoice) selectedChoice = [];
                
                if (selectedChoice.includes(choiceId)) {
                    // é¸æŠè§£é™¤
                    selectedChoice = selectedChoice.filter(id => id !== choiceId);
                    clickedButton.classList.remove('selected');
                } else {
                    // é¸æŠè¿½åŠ 
                    selectedChoice.push(choiceId);
                    clickedButton.classList.add('selected');
                }
            } else {
                // å˜ä¸€é¸æŠãƒ¢ãƒ¼ãƒ‰
                buttons.forEach(btn => btn.classList.remove('selected'));
                clickedButton.classList.add('selected');
                selectedChoice = choiceId;
            }
            
            // é€ä¿¡ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
            const submitBtn = document.getElementById('choice-submit-btn');
            const hasSelection = multiSelect ? 
                (selectedChoice && selectedChoice.length > 0) : 
                (selectedChoice !== null);
            submitBtn.disabled = !hasSelection;
        }
        
        // é¸æŠè‚¢å›ç­”é€ä¿¡
        function submitChoiceAnswer(step) {
            if (!selectedChoice || (Array.isArray(selectedChoice) && selectedChoice.length === 0)) {
                return;
            }
            
            setProcessing(true);
            
            // å›ç­”ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            let answerText;
            if (Array.isArray(selectedChoice)) {
                answerText = selectedChoice.map(id => {
                    const choice = step.choices.find(c => c.id === id);
                    return choice ? choice.text : '';
                }).join('\n');
            } else {
                const choice = step.choices.find(c => c.id === selectedChoice);
                answerText = choice ? choice.text : '';
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            addUserMessage(answerText);
            
            // å›ç­”ä¿å­˜
            window.alsokStorage.addScreeningResponse(
                applicantId, 
                step.id, 
                step.question, 
                answerText, 
                'choice'
            );
            
            // ã‚¹ãƒ†ãƒƒãƒ—åˆ¥å‡¦ç†
            processStepResponse(step, selectedChoice);
            
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
            currentStep++;
            setTimeout(() => {
                if (currentStep < screeningSteps.length) {
                    showNextStep();
                    setProcessing(false);
                } else {
                    completeScreening();
                }
            }, 2000);
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆå›ç­”é€ä¿¡
        function submitTextAnswer(step) {
            const textInput = document.getElementById('text-input');
            const answer = textInput.value.trim();
            
            if (!answer) return;
            
            setProcessing(true);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            addUserMessage(answer);
            
            // å›ç­”ä¿å­˜
            window.alsokStorage.addScreeningResponse(
                applicantId,
                step.id,
                step.question,
                answer,
                'text'
            );
            
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
            currentStep++;
            setTimeout(() => {
                completeScreening();
            }, 2000);
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†
        function processStepResponse(step, answer) {
            switch (step.id) {
                case 1: // å¿œå‹ŸçµŒè·¯
                    window.alsokStorage.setApplicationSource(applicantId, answer);
                    break;
                    
                case 2: // æ¬ æ ¼äº‹ç”±ãƒã‚§ãƒƒã‚¯
                    if (Array.isArray(answer)) {
                        const reasons = answer.filter(id => id !== 6); // 6ç•ªä»¥å¤–ã¯æ¬ æ ¼äº‹ç”±
                        disqualificationReasons = reasons;
                        window.alsokStorage.setDisqualificationCheck(applicantId, reasons);
                    }
                    break;
                    
                case 3: // å‹¤å‹™æœŸé–“
                case 4: // ä½“åŠ›é¢
                    // ä»Šå¾Œã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã«ä½¿ç”¨
                    break;
            }
        }
        
        // äº‹å‰ç²¾æŸ»å®Œäº†
        function completeScreening() {
            // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            let completionMessage;
            let messageClass;
            let nextAction;
            
            if (disqualificationReasons.length > 0) {
                // æ¬ æ ¼äº‹ç”±ã‚ã‚Š
                completionMessage = `${applicantData.name}ã•ã‚“ã€äº‹å‰ç¢ºèªãŒå®Œäº†ã„ãŸã—ã¾ã—ãŸã€‚<br><br>` +
                                  `èª ã«ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€æ³•çš„è¦ä»¶ã«ã‚ˆã‚Šä»Šå›ã¯æ¡ç”¨ã‚’è¦‹é€ã‚‰ã›ã¦ã„ãŸã ãã“ã¨ã¨ãªã‚Šã¾ã—ãŸã€‚<br>` +
                                  `è²´é‡ãªãŠæ™‚é–“ã‚’ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚`;
                messageClass = 'disqualified-alert';
                nextAction = 'disqualified';
                
                window.alsokStorage.setInterviewEligibility(applicantId, false, 0);
            } else {
                // é©æ ¼è€…
                completionMessage = `${applicantData.name}ã•ã‚“ã€äº‹å‰ç¢ºèªãŒå®Œäº†ã„ãŸã—ã¾ã—ãŸã€‚<br><br>` +
                                  `ã™ã¹ã¦ã®é …ç›®ã§åŸºæº–ã‚’æº€ãŸã—ã¦ãŠã‚Šã€é¢æ¥å¯¾è±¡è€…ã¨ã—ã¦é¸å‡ºã„ãŸã—ã¾ã™ã€‚<br>` +
                                  `å¾Œæ—¥ã€é¢æ¥æ—¥ç¨‹ã«ã¤ã„ã¦ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚<br>` +
                                  `ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼`;
                messageClass = 'qualified-alert';
                nextAction = 'qualified';
                
                // åŸºæœ¬çš„ãªã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const score = calculateRecruitmentScore();
                window.alsokStorage.setInterviewEligibility(applicantId, true, score);
            }
            
            // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            setTimeout(() => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `${messageClass} rounded-2xl p-4 mb-4 fade-in`;
                
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                            ğŸ‘¤
                        </div>
                        <div>
                            <div class="font-medium text-gray-800 mb-1">ALSOKæ¡ç”¨æ‹…å½“è€…</div>
                            <div class="text-gray-700 leading-relaxed">
                                ${completionMessage}
                            </div>
                        </div>
                    </div>
                `;
                
                chatContainer.appendChild(messageDiv);
                scrollToBottom();
            }, 1000);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            window.alsokStorage.updateApplicant(applicantId, {
                status: nextAction === 'qualified' ? 'interview_completed' : 'disqualified',
                screeningCompletedAt: new Date().toISOString()
            });
            
            screeningStatus.textContent = 'äº‹å‰ç²¾æŸ»å®Œäº†';
            setProcessing(false, nextAction);
            
            // æ¬¡ç”»é¢ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            setTimeout(() => {
                // ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Œäº†å¾Œã¯å¸¸ã«å®Œäº†ç”»é¢ã«é·ç§»
                window.location.href = `/completed?id=${applicantId}`;
            }, 5000);
        }
        
        // æ¡ç”¨å¯èƒ½æ€§ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function calculateRecruitmentScore() {
            let score = 50; // ãƒ™ãƒ¼ã‚¹ã‚¹ã‚³ã‚¢
            
            const responses = applicantData.screeningResponses || [];
            
            // å‹¤å‹™æœŸé–“ã«ã‚ˆã‚‹åŠ ç‚¹
            const durationResponse = responses.find(r => r.step === 3);
            if (durationResponse && durationResponse.answer.includes('1å¹´ä»¥ä¸Š')) {
                score += 30;
            } else if (durationResponse && durationResponse.answer.includes('åŠå¹´ã€œ1å¹´')) {
                score += 20;
            }
            
            // ä½“åŠ›é¢ã«ã‚ˆã‚‹åŠ ç‚¹
            const physicalResponse = responses.find(r => r.step === 4);
            if (physicalResponse && physicalResponse.answer.includes('ã™ã¹ã¦å¯¾å¿œå¯èƒ½')) {
                score += 20;
            }
            
            return Math.min(100, Math.max(0, score));
        }
        
        // UIçŠ¶æ…‹ç®¡ç†
        function setProcessing(isProcessing, completionType = null) {
            hideAllForms();
            
            if (isProcessing) {
                document.getElementById('processing-state').classList.remove('hidden');
            } else if (completionType) {
                const completedState = document.getElementById('completed-state');
                const completionMessage = document.getElementById('completion-message');
                
                if (completionType === 'qualified') {
                    completionMessage.className = 'qualified-alert px-4 py-2 rounded-lg inline-block';
                    completionMessage.textContent = 'âœ… äº‹å‰ç²¾æŸ»å®Œäº† - é¢æ¥å®Ÿæ–½æ±ºå®š';
                } else {
                    completionMessage.className = 'disqualified-alert px-4 py-2 rounded-lg inline-block';
                    completionMessage.textContent = 'âš ï¸ äº‹å‰ç²¾æŸ»å®Œäº† - è¦ä»¶ã«ã‚ˆã‚Šè¦‹é€ã‚Š';
                }
                
                completedState.classList.remove('hidden');
            }
        }
        
        // ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
        function hideAllForms() {
            document.getElementById('choice-form').classList.add('hidden');
            document.getElementById('text-form').classList.add('hidden');
            document.getElementById('processing-state').classList.add('hidden');
            document.getElementById('completed-state').classList.add('hidden');
        }
        
        // ãƒãƒ£ãƒƒãƒˆæœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollToBottom() {
            setTimeout(() => {
                const chatContainer = document.getElementById('chat-container');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, 200);
        }
        
        // ãƒšãƒ¼ã‚¸é›¢è„±ç¢ºèª
        window.addEventListener('beforeunload', function(e) {
            if (currentStep > 0 && currentStep < screeningSteps.length) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>