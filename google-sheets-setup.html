<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets API Setup - ALSOK Interview Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        alsok: {
                            blue: '#0066CC',
                            red: '#E60012',
                            gray: '#666666'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .setup-step {
            transition: all 0.3s ease;
        }
        .setup-step.completed {
            opacity: 0.7;
            transform: scale(0.98);
        }
        .credential-input:focus {
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected { background-color: #10B981; }
        .status-disconnected { background-color: #EF4444; }
        .status-demo { background-color: #F59E0B; }
        .status-loading { 
            background-color: #6B7280; 
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-alsok-blue">Google Sheets API セットアップ</h1>
                <div class="flex items-center">
                    <span class="status-indicator" id="connectionStatusIndicator"></span>
                    <span id="connectionStatusText" class="text-sm font-medium">未接続</span>
                </div>
            </div>
            <p class="text-gray-600">ALSOK面接デモシステムをGoogle Spreadsheetsと連携させるための設定を行います。</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Setup Steps -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">セットアップ手順</h2>
                
                <div class="space-y-4">
                    <div class="setup-step border rounded-lg p-4" id="step1">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-alsok-blue text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">1</div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">Google Cloud Console プロジェクト作成</h3>
                                <p class="text-sm text-gray-600 mt-1">Google Cloud Console でプロジェクトを作成します</p>
                                <a href="https://console.cloud.google.com/" target="_blank" class="inline-flex items-center mt-2 text-alsok-blue hover:text-alsok-red text-sm">
                                    Google Cloud Console を開く
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="setup-step border rounded-lg p-4" id="step2">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-alsok-blue text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">2</div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">Google Sheets API 有効化</h3>
                                <p class="text-sm text-gray-600 mt-1">作成したプロジェクトでGoogle Sheets APIを有効にします</p>
                                <a href="https://console.cloud.google.com/apis/library/sheets.googleapis.com" target="_blank" class="inline-flex items-center mt-2 text-alsok-blue hover:text-alsok-red text-sm">
                                    Sheets API ライブラリを開く
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="setup-step border rounded-lg p-4" id="step3">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-alsok-blue text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">3</div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">API キー作成</h3>
                                <p class="text-sm text-gray-600 mt-1">APIアクセス用のキーを生成します</p>
                                <div class="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded">
                                    認証情報 → APIキー → 作成 → キーをコピー
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="setup-step border rounded-lg p-4" id="step4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 bg-alsok-blue text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">4</div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">スプレッドシート準備</h3>
                                <p class="text-sm text-gray-600 mt-1">データ保存用のスプレッドシートを作成・共有します</p>
                                <a href="https://docs.google.com/spreadsheets/create" target="_blank" class="inline-flex items-center mt-2 text-alsok-blue hover:text-alsok-red text-sm">
                                    新しいスプレッドシートを作成
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">認証情報設定</h2>
                
                <form id="credentialsForm" class="space-y-6">
                    <!-- API Key Input -->
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">
                            Google Sheets API キー *
                        </label>
                        <input 
                            type="text" 
                            id="apiKey" 
                            name="apiKey"
                            class="credential-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-alsok-blue focus:border-alsok-blue"
                            placeholder="AIzaSy..."
                            autocomplete="off"
                        >
                        <p class="text-xs text-gray-500 mt-1">Google Cloud Console で作成したAPIキーを入力してください</p>
                    </div>

                    <!-- Sheet ID Input -->
                    <div>
                        <label for="sheetId" class="block text-sm font-medium text-gray-700 mb-2">
                            スプレッドシート ID *
                        </label>
                        <input 
                            type="text" 
                            id="sheetId" 
                            name="sheetId"
                            class="credential-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-alsok-blue focus:border-alsok-blue"
                            placeholder="1BvHPQ177..."
                            autocomplete="off"
                        >
                        <p class="text-xs text-gray-500 mt-1">スプレッドシートURLの「/spreadsheets/d/」と「/edit」の間の部分</p>
                    </div>

                    <!-- Actions -->
                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 bg-alsok-blue hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                            接続テスト
                        </button>
                        <button type="button" id="demoModeBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition-colors">
                            デモモード
                        </button>
                    </div>
                </form>

                <!-- Status Messages -->
                <div id="statusMessage" class="mt-4 p-3 rounded-md hidden">
                    <div id="statusContent"></div>
                </div>

                <!-- Current Configuration -->
                <div id="currentConfig" class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-800 mb-2">現在の設定</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div>API キー: <span id="currentApiKey" class="font-mono">未設定</span></div>
                        <div>スプレッドシート: <span id="currentSheetId" class="font-mono">未設定</span></div>
                        <div>ステータス: <span id="currentStatus">未接続</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demo Sheet Template -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">スプレッドシートテンプレート</h2>
            <p class="text-gray-600 mb-4">以下のヘッダーを使用してスプレッドシートを準備してください：</p>
            
            <div class="bg-gray-50 p-4 rounded-lg overflow-x-auto">
                <div class="grid grid-cols-9 gap-2 text-xs whitespace-nowrap">
                    <div class="bg-alsok-blue text-white p-2 rounded">応募日時</div>
                    <div class="bg-alsok-blue text-white p-2 rounded">応募者名</div>
                    <div class="bg-alsok-blue text-white p-2 rounded">電話番号</div>
                    <div class="bg-alsok-blue text-white p-2 rounded">応募経路</div>
                    <div class="bg-alsok-blue text-white p-2 rounded">年齢確認</div>
                    <div class="bg-alsok-blue text-white p-2 rounded">国籍確認</div>
                    <div class="bg-alsok-blue text-white p-2 rounded">過去の逮捕歴</div>
                    <div class="bg-alsok-blue text-white p-2 rounded">暴力団関係</div>
                    <div class="bg-alsok-blue text-white p-2 rounded">精神的な病気</div>
                </div>
                <div class="text-center mt-2 text-gray-500">... 他18列（総計27列）</div>
            </div>
            
            <div class="mt-4 flex space-x-3">
                <button id="copyHeadersBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm">
                    ヘッダーをコピー
                </button>
                <button id="downloadTemplateBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm">
                    テンプレートダウンロード
                </button>
            </div>
        </div>

        <!-- Back to Admin -->
        <div class="mt-6 text-center">
            <a href="admin-dashboard.html" class="inline-flex items-center text-alsok-blue hover:text-alsok-red">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                管理画面に戻る
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="google-sheets-config.js"></script>
    <script src="google-sheets-api.js"></script>
    <script>
        // Google Sheets Setup UI Controller
        class GoogleSheetsSetupUI {
            constructor() {
                this.form = document.getElementById('credentialsForm');
                this.apiKeyInput = document.getElementById('apiKey');
                this.sheetIdInput = document.getElementById('sheetId');
                this.statusMessage = document.getElementById('statusMessage');
                this.statusContent = document.getElementById('statusContent');
                this.demoModeBtn = document.getElementById('demoModeBtn');
                
                this.initializeUI();
                this.bindEvents();
                this.loadCurrentConfig();
            }

            initializeUI() {
                // Initialize with current configuration
                this.updateConnectionStatus('disconnected');
            }

            bindEvents() {
                // Form submission
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.testConnection();
                });

                // Demo mode button
                this.demoModeBtn.addEventListener('click', () => {
                    this.enterDemoMode();
                });

                // Copy headers button
                document.getElementById('copyHeadersBtn')?.addEventListener('click', () => {
                    this.copyHeaders();
                });

                // Download template button
                document.getElementById('downloadTemplateBtn')?.addEventListener('click', () => {
                    this.downloadTemplate();
                });

                // Real-time validation
                this.apiKeyInput.addEventListener('input', () => {
                    this.validateInputs();
                });

                this.sheetIdInput.addEventListener('input', () => {
                    this.validateInputs();
                });

                // Listen for connection status updates
                document.addEventListener('sheetsConnectionStatus', (e) => {
                    this.updateConnectionStatus(e.detail.status);
                });
            }

            async loadCurrentConfig() {
                const credentials = googleSheetsConfig.getCredentials();
                
                // Mask API key for security
                if (credentials.apiKey) {
                    this.apiKeyInput.value = credentials.apiKey;
                    document.getElementById('currentApiKey').textContent = 
                        credentials.apiKey.substring(0, 8) + '...';
                }
                
                if (credentials.sheetId) {
                    this.sheetIdInput.value = credentials.sheetId;
                    document.getElementById('currentSheetId').textContent = 
                        credentials.sheetId.substring(0, 12) + '...';
                }

                // Test existing connection
                if (credentials.apiKey && credentials.sheetId) {
                    this.updateConnectionStatus('loading');
                    const result = await initializeGoogleSheets(credentials);
                    this.handleConnectionResult(result);
                }
            }

            async testConnection() {
                const apiKey = this.apiKeyInput.value.trim();
                const sheetId = this.sheetIdInput.value.trim();

                // Validate inputs
                const validation = googleSheetsConfig.validateCredentials(apiKey, sheetId);
                if (!validation.isValid) {
                    this.showStatus('error', validation.errors.join('<br>'));
                    return;
                }

                // Show loading state
                this.updateConnectionStatus('loading');
                this.showStatus('info', '接続をテストしています...');

                // Save credentials
                googleSheetsConfig.setCredentials(apiKey, sheetId);

                // Test connection
                const result = await initializeGoogleSheets({ apiKey, sheetId });
                this.handleConnectionResult(result);
            }

            handleConnectionResult(result) {
                if (result.success) {
                    this.updateConnectionStatus('connected');
                    this.showStatus('success', '✅ ' + result.message);
                    this.updateCurrentConfig();
                } else {
                    this.updateConnectionStatus('error');
                    this.showStatus('error', '❌ ' + result.message);
                }
            }

            enterDemoMode() {
                this.updateConnectionStatus('demo');
                this.showStatus('info', '📋 デモモードが有効になりました。データはローカルに保存されます。');
                
                // Set demo configuration
                const demoConfig = googleSheetsConfig.getDemoConfig();
                googleSheetsConfig.saveConfig(demoConfig);
                this.loadCurrentConfig();
            }

            updateConnectionStatus(status) {
                const indicator = document.getElementById('connectionStatusIndicator');
                const text = document.getElementById('connectionStatusText');
                const currentStatusSpan = document.getElementById('currentStatus');

                // Remove all status classes
                indicator.className = 'status-indicator';
                
                let statusText = '';
                switch (status) {
                    case 'connected':
                        indicator.classList.add('status-connected');
                        statusText = '接続済み';
                        break;
                    case 'error':
                        indicator.classList.add('status-disconnected');
                        statusText = 'エラー';
                        break;
                    case 'demo':
                        indicator.classList.add('status-demo');
                        statusText = 'デモモード';
                        break;
                    case 'loading':
                        indicator.classList.add('status-loading');
                        statusText = '接続中...';
                        break;
                    default:
                        indicator.classList.add('status-disconnected');
                        statusText = '未接続';
                }

                text.textContent = statusText;
                currentStatusSpan.textContent = statusText;
            }

            showStatus(type, message) {
                const typeClasses = {
                    success: 'bg-green-50 text-green-800 border border-green-200',
                    error: 'bg-red-50 text-red-800 border border-red-200',
                    info: 'bg-blue-50 text-blue-800 border border-blue-200',
                    warning: 'bg-yellow-50 text-yellow-800 border border-yellow-200'
                };

                this.statusMessage.className = `mt-4 p-3 rounded-md ${typeClasses[type] || typeClasses.info}`;
                this.statusContent.innerHTML = message;
                this.statusMessage.classList.remove('hidden');

                // Auto-hide after 10 seconds for non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        this.statusMessage.classList.add('hidden');
                    }, 10000);
                }
            }

            validateInputs() {
                // Add visual validation feedback here if needed
            }

            updateCurrentConfig() {
                const credentials = googleSheetsConfig.getCredentials();
                
                if (credentials.apiKey) {
                    document.getElementById('currentApiKey').textContent = 
                        credentials.apiKey.substring(0, 8) + '...';
                }
                
                if (credentials.sheetId) {
                    document.getElementById('currentSheetId').textContent = 
                        credentials.sheetId.substring(0, 12) + '...';
                }
            }

            copyHeaders() {
                const headers = [
                    '応募日時', '応募者名', '電話番号', '応募経路', '年齢確認', '国籍確認',
                    '過去の逮捕歴', '暴力団関係', '精神的な病気', 'アルコール依存症', '薬物依存症',
                    '住居確認', '連絡先確認', '面接希望', '特記事項', '失格状況', '総合結果',
                    '完了時間', 'デバイス種別', 'IPアドレス', 'ユーザーエージェント', 'セッションID',
                    'リファラー', '画面解像度', '言語設定', 'タイムゾーン', '備考'
                ].join('\t');

                navigator.clipboard.writeText(headers).then(() => {
                    this.showStatus('success', 'ヘッダーがクリップボードにコピーされました');
                }).catch(() => {
                    this.showStatus('error', 'コピーに失敗しました');
                });
            }

            downloadTemplate() {
                const headers = GoogleSheetsAPI.getSheetHeaders();
                const csv = '\uFEFF' + headers.join(',') + '\n'; // Add BOM for Excel compatibility
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'ALSOK_応募者データテンプレート.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showStatus('success', 'テンプレートファイルをダウンロードしました');
            }
        }

        // Initialize the setup UI when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new GoogleSheetsSetupUI();
        });
    </script>
</body>
</html>