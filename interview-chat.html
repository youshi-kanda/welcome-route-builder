<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ALSOK AI面接 - 面接中</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        .chat-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .message-ai {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-left: 4px solid #3b82f6;
        }
        
        .message-user {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .typing-indicator {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 20% { opacity: 0; }
            40% { opacity: 0.5; }
            60%, 100% { opacity: 1; }
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .bounce {
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .response-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        /* スクロールバーのカスタマイズ */
        .chat-container::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 2px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- ヘッダー -->
    <header class="gradient-bg shadow-lg">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="ai-avatar w-10 h-10 rounded-full flex items-center justify-center text-white text-lg">
                        🤖
                    </div>
                    <div>
                        <h1 class="text-white font-semibold">AI面接官</h1>
                        <p class="text-blue-200 text-sm" id="interview-status">面接開始</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-white text-sm">質問 <span id="question-counter">1</span>/5</div>
                    <div class="text-blue-200 text-xs" id="applicant-name">---</div>
                </div>
            </div>
            
            <!-- プログレスバー -->
            <div class="mt-3 bg-blue-900 bg-opacity-50 rounded-full h-2">
                <div id="progress-bar" class="progress-bar bg-white h-2 rounded-full" style="width: 20%"></div>
            </div>
        </div>
    </header>

    <!-- チャットエリア -->
    <main class="chat-container px-4 py-4" id="chat-container">
        
        <!-- ウェルカムメッセージ -->
        <div class="message-ai rounded-2xl p-4 mb-4 fade-in">
            <div class="flex items-start space-x-3">
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                    🤖
                </div>
                <div>
                    <div class="font-medium text-gray-800 mb-1">AI面接官</div>
                    <div class="text-gray-700 leading-relaxed">
                        こんにちは！ALSOK採用面接にお越しいただき、ありがとうございます。<br>
                        これから5つの質問をさせていただきます。リラックスしてお答えください。
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        ⏱️ 各質問に十分時間をかけてお答えください
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 動的メッセージがここに追加されます -->
        
    </main>

    <!-- 回答入力エリア -->
    <footer class="response-area fixed bottom-0 left-0 right-0 p-4" id="response-area">
        
        <!-- 入力フォーム -->
        <div id="answer-form" class="space-y-3">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-2">
                    👤
                </div>
                <div class="flex-1">
                    <textarea 
                        id="answer-input" 
                        placeholder="こちらに回答を入力してください..."
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none resize-none"
                        rows="3"
                        maxlength="500"
                    ></textarea>
                    <div class="flex items-center justify-between mt-2">
                        <div class="text-xs text-gray-500">
                            <span id="char-count">0</span>/500 文字
                        </div>
                        <button 
                            id="send-btn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            📤 送信
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 送信完了状態 -->
        <div id="sending-state" class="hidden text-center py-4">
            <div class="inline-flex items-center space-x-2 bg-blue-100 text-blue-800 px-4 py-2 rounded-lg">
                <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>回答を送信中...</span>
            </div>
        </div>
        
        <!-- 面接完了状態 -->
        <div id="completed-state" class="hidden text-center py-4">
            <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg inline-block">
                ✅ 面接が完了しました
            </div>
        </div>
    </footer>

    <!-- 共有ストレージライブラリ -->
    <script src="shared-storage.js"></script>
    
    <script>
        // グローバル変数
        let applicantId = null;
        let currentQuestion = 0;
        let applicantData = null;
        let isProcessing = false;
        
        // 質問リスト
        const questions = [
            {
                id: 1,
                text: "まず、自己紹介をお願いします。お名前、年齢、これまでの職歴や経験について教えてください。",
                hint: "簡潔で構いませんので、あなたのことを教えてください"
            },
            {
                id: 2,
                text: "警備業に興味を持ったきっかけや理由を教えてください。",
                hint: "なぜALSOKで働きたいと思われたのですか？"
            },
            {
                id: 3,
                text: "夜勤や不規則な勤務時間がある場合がありますが、対応可能でしょうか？理由も含めてお聞かせください。",
                hint: "実際の勤務条件についてのご質問です"
            },
            {
                id: 4,
                text: "チームワークを重視する場面での経験があれば教えてください。困難だった状況をどのように乗り越えましたか？",
                hint: "具体的なエピソードがあればお聞かせください"
            },
            {
                id: 5,
                text: "最後に、ALSOKで働く意気込みや、将来の目標があれば教えてください。",
                hint: "あなたの熱意をお聞かせください"
            }
        ];
        
        // DOM要素
        const chatContainer = document.getElementById('chat-container');
        const answerInput = document.getElementById('answer-input');
        const sendBtn = document.getElementById('send-btn');
        const charCount = document.getElementById('char-count');
        const questionCounter = document.getElementById('question-counter');
        const progressBar = document.getElementById('progress-bar');
        const applicantNameEl = document.getElementById('applicant-name');
        const interviewStatus = document.getElementById('interview-status');
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeInterview();
        });
        
        // 面接初期化
        function initializeInterview() {
            // URLパラメータから応募者ID取得
            const urlParams = new URLSearchParams(window.location.search);
            applicantId = urlParams.get('id');
            
            if (!applicantId) {
                alert('エラー: 応募者IDが見つかりません');
                window.location.href = '/mobile';
                return;
            }
            
            // 応募者データ取得
            applicantData = window.alsokStorage.getApplicant(applicantId);
            if (!applicantData) {
                alert('エラー: 応募者情報が見つかりません');
                window.location.href = '/mobile';
                return;
            }
            
            // UI初期化
            applicantNameEl.textContent = applicantData.name;
            
            // 面接開始状態に更新
            window.alsokStorage.updateApplicant(applicantId, {
                status: 'interview_started'
            });
            
            // イベントリスナー設定
            setupEventListeners();
            
            // 最初の質問を表示
            setTimeout(() => {
                showNextQuestion();
            }, 2000);
        }
        
        // イベントリスナー設定
        function setupEventListeners() {
            // 送信ボタン
            sendBtn.addEventListener('click', submitAnswer);
            
            // 入力欄の変更監視
            answerInput.addEventListener('input', handleInputChange);
            
            // Enterキーで送信（Shift+Enterで改行）
            answerInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        submitAnswer();
                    }
                }
            });
        }
        
        // 入力変更処理
        function handleInputChange() {
            const text = answerInput.value.trim();
            const length = text.length;
            
            // 文字数更新
            charCount.textContent = length;
            
            // 送信ボタン状態更新
            sendBtn.disabled = length === 0 || length > 500 || isProcessing;
            
            // 文字数制限の警告
            if (length > 450) {
                charCount.className = length > 500 ? 'text-red-600 font-semibold' : 'text-yellow-600';
            } else {
                charCount.className = 'text-gray-500';
            }
        }
        
        // 次の質問を表示
        function showNextQuestion() {
            if (currentQuestion >= questions.length) {
                completeInterview();
                return;
            }
            
            const question = questions[currentQuestion];
            
            // UI更新
            questionCounter.textContent = question.id;
            progressBar.style.width = `${(question.id / questions.length) * 100}%`;
            interviewStatus.textContent = `質問 ${question.id}`;
            
            // AI質問メッセージを追加
            setTimeout(() => {
                addAIMessage(question.text, question.hint);
                enableInput();
            }, 1000);
        }
        
        // AIメッセージ追加
        function addAIMessage(text, hint = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-ai rounded-2xl p-4 mb-4 fade-in';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                        🤖
                    </div>
                    <div>
                        <div class="font-medium text-gray-800 mb-1">AI面接官</div>
                        <div class="text-gray-700 leading-relaxed">
                            ${text}
                        </div>
                        ${hint ? `
                            <div class="text-xs text-gray-500 mt-2 bg-gray-100 rounded-lg p-2">
                                💡 ${hint}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // ユーザーメッセージ追加
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-user rounded-2xl p-4 mb-4 fade-in ml-8';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3 justify-end">
                    <div class="text-right">
                        <div class="font-medium text-white mb-1">あなたの回答</div>
                        <div class="text-white leading-relaxed">
                            ${text.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                        👤
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // 回答送信
        function submitAnswer() {
            const answer = answerInput.value.trim();
            
            if (!answer || isProcessing) {
                return;
            }
            
            isProcessing = true;
            setUIState('sending');
            
            // ユーザーメッセージ表示
            addUserMessage(answer);
            
            // 回答をストレージに保存
            const question = questions[currentQuestion];
            window.alsokStorage.addInterviewResponse(applicantId, question.text, answer);
            
            // 入力欄クリア
            answerInput.value = '';
            handleInputChange();
            
            // 次の質問または完了処理
            currentQuestion++;
            
            setTimeout(() => {
                if (currentQuestion < questions.length) {
                    // 次の質問
                    showNextQuestion();
                    setUIState('input');
                    isProcessing = false;
                } else {
                    // 面接完了
                    completeInterview();
                }
            }, 2000);
        }
        
        // 面接完了
        function completeInterview() {
            // 完了メッセージ表示
            setTimeout(() => {
                addAIMessage(
                    `${applicantData.name}さん、面接は以上で終了です。お疲れ様でした！<br><br>` +
                    `すべての質問にご回答いただき、ありがとうございました。<br>` +
                    `選考結果については、後日担当者よりご連絡させていただきます。`
                );
            }, 1000);
            
            // ステータス更新
            window.alsokStorage.updateApplicant(applicantId, {
                status: 'interview_completed'
            });
            
            interviewStatus.textContent = '面接完了';
            setUIState('completed');
            
            // 完了画面へリダイレクト
            setTimeout(() => {
                window.location.href = `/completed?id=${applicantId}`;
            }, 5000);
        }
        
        // UI状態管理
        function setUIState(state) {
            const answerForm = document.getElementById('answer-form');
            const sendingState = document.getElementById('sending-state');
            const completedState = document.getElementById('completed-state');
            
            // すべて非表示
            answerForm.classList.add('hidden');
            sendingState.classList.add('hidden');
            completedState.classList.add('hidden');
            
            // 該当状態を表示
            switch (state) {
                case 'input':
                    answerForm.classList.remove('hidden');
                    break;
                case 'sending':
                    sendingState.classList.remove('hidden');
                    break;
                case 'completed':
                    completedState.classList.remove('hidden');
                    break;
            }
        }
        
        // 入力有効化
        function enableInput() {
            setUIState('input');
            answerInput.focus();
        }
        
        // チャット最下部へスクロール
        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }
        
        // ページ離脱確認
        window.addEventListener('beforeunload', function(e) {
            if (currentQuestion > 0 && currentQuestion < questions.length) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>