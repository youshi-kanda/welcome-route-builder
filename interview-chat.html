<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ALSOK AIé¢æ¥ - é¢æ¥ä¸­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }
        
        .chat-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .message-ai {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-left: 4px solid #3b82f6;
        }
        
        .message-user {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .typing-indicator {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 20% { opacity: 0; }
            40% { opacity: 0.5; }
            60%, 100% { opacity: 1; }
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .bounce {
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .response-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .chat-container::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 2px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="gradient-bg shadow-lg">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="ai-avatar w-10 h-10 rounded-full flex items-center justify-center text-white text-lg">
                        ğŸ¤–
                    </div>
                    <div>
                        <h1 class="text-white font-semibold">AIé¢æ¥å®˜</h1>
                        <p class="text-blue-200 text-sm" id="interview-status">é¢æ¥é–‹å§‹</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-white text-sm">è³ªå• <span id="question-counter">1</span>/5</div>
                    <div class="text-blue-200 text-xs" id="applicant-name">---</div>
                </div>
            </div>
            
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
            <div class="mt-3 bg-blue-900 bg-opacity-50 rounded-full h-2">
                <div id="progress-bar" class="progress-bar bg-white h-2 rounded-full" style="width: 20%"></div>
            </div>
        </div>
    </header>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <main class="chat-container px-4 py-4" id="chat-container">
        
        <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="message-ai rounded-2xl p-4 mb-4 fade-in">
            <div class="flex items-start space-x-3">
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                    ğŸ¤–
                </div>
                <div>
                    <div class="font-medium text-gray-800 mb-1">AIé¢æ¥å®˜</div>
                    <div class="text-gray-700 leading-relaxed">
                        ã“ã‚“ã«ã¡ã¯ï¼ALSOKæ¡ç”¨é¢æ¥ã«ãŠè¶Šã—ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
                        ã“ã‚Œã‹ã‚‰5ã¤ã®è³ªå•ã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãŠç­”ãˆãã ã•ã„ã€‚
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        â±ï¸ å„è³ªå•ã«ååˆ†æ™‚é–“ã‚’ã‹ã‘ã¦ãŠç­”ãˆãã ã•ã„
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å‹•çš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        
    </main>

    <!-- å›ç­”å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <footer class="response-area fixed bottom-0 left-0 right-0 p-4" id="response-area">
        
        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="answer-form" class="space-y-3">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-2">
                    ğŸ‘¤
                </div>
                <div class="flex-1">
                    <textarea 
                        id="answer-input" 
                        placeholder="ã“ã¡ã‚‰ã«å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none resize-none"
                        rows="3"
                        maxlength="500"
                    ></textarea>
                    <div class="flex items-center justify-between mt-2">
                        <div class="text-xs text-gray-500">
                            <span id="char-count">0</span>/500 æ–‡å­—
                        </div>
                        <button 
                            id="send-btn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            ğŸ“¤ é€ä¿¡
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é€ä¿¡å®Œäº†çŠ¶æ…‹ -->
        <div id="sending-state" class="hidden text-center py-4">
            <div class="inline-flex items-center space-x-2 bg-blue-100 text-blue-800 px-4 py-2 rounded-lg">
                <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="12" cy="12" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
                <span>å›ç­”ã‚’é€ä¿¡ä¸­...</span>
            </div>
        </div>
        
        <!-- é¢æ¥å®Œäº†çŠ¶æ…‹ -->
        <div id="completed-state" class="hidden text-center py-4">
            <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg inline-block">
                âœ… é¢æ¥ãŒå®Œäº†ã—ã¾ã—ãŸ
            </div>
        </div>
    </footer>

    <!-- å…±æœ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="shared-storage.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let applicantId = null;
        let currentQuestion = 0;
        let applicantData = null;
        let isProcessing = false;
        
        // è³ªå•ãƒªã‚¹ãƒˆ
        const questions = [
            {
                id: 1,
                text: "ã¾ãšã€è‡ªå·±ç´¹ä»‹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚ãŠåå‰ã€å¹´é½¢ã€ã“ã‚Œã¾ã§ã®è·æ­´ã‚„çµŒé¨“ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚",
                hint: "ç°¡æ½”ã§æ§‹ã„ã¾ã›ã‚“ã®ã§ã€ã‚ãªãŸã®ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„"
            },
            {
                id: 2,
                text: "è­¦å‚™æ¥­ã«èˆˆå‘³ã‚’æŒã£ãŸãã£ã‹ã‘ã‚„ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
                hint: "ãªãœALSOKã§åƒããŸã„ã¨æ€ã‚ã‚ŒãŸã®ã§ã™ã‹ï¼Ÿ"
            },
            {
                id: 3,
                text: "å¤œå‹¤ã‚„ä¸è¦å‰‡ãªå‹¤å‹™æ™‚é–“ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€å¯¾å¿œå¯èƒ½ã§ã—ã‚‡ã†ã‹ï¼Ÿç†ç”±ã‚‚å«ã‚ã¦ãŠèã‹ã›ãã ã•ã„ã€‚",
                hint: "å®Ÿéš›ã®å‹¤å‹™æ¡ä»¶ã«ã¤ã„ã¦ã®ã”è³ªå•ã§ã™"
            },
            {
                id: 4,
                text: "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’é‡è¦–ã™ã‚‹å ´é¢ã§ã®çµŒé¨“ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚å›°é›£ã ã£ãŸçŠ¶æ³ã‚’ã©ã®ã‚ˆã†ã«ä¹—ã‚Šè¶Šãˆã¾ã—ãŸã‹ï¼Ÿ",
                hint: "å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ãŠèã‹ã›ãã ã•ã„"
            },
            {
                id: 5,
                text: "æœ€å¾Œã«ã€ALSOKã§åƒãæ„æ°—è¾¼ã¿ã‚„ã€å°†æ¥ã®ç›®æ¨™ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚",
                hint: "ã‚ãªãŸã®ç†±æ„ã‚’ãŠèã‹ã›ãã ã•ã„"
            }
        ];
        
        // DOMè¦ç´ 
        const chatContainer = document.getElementById('chat-container');
        const answerInput = document.getElementById('answer-input');
        const sendBtn = document.getElementById('send-btn');
        const charCount = document.getElementById('char-count');
        const questionCounter = document.getElementById('question-counter');
        const progressBar = document.getElementById('progress-bar');
        const applicantNameEl = document.getElementById('applicant-name');
        const interviewStatus = document.getElementById('interview-status');
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeInterview();
        });
        
        // é¢æ¥åˆæœŸåŒ–
        function initializeInterview() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å¿œå‹Ÿè€…IDå–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            applicantId = urlParams.get('id');
            
            if (!applicantId) {
                alert('ã‚¨ãƒ©ãƒ¼: å¿œå‹Ÿè€…IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = '/mobile';
                return;
            }
            
            // å¿œå‹Ÿè€…ãƒ‡ãƒ¼ã‚¿å–å¾—
            applicantData = window.alsokStorage.getApplicant(applicantId);
            if (!applicantData) {
                alert('ã‚¨ãƒ©ãƒ¼: å¿œå‹Ÿè€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = '/mobile';
                return;
            }
            
            // UIåˆæœŸåŒ–
            applicantNameEl.textContent = applicantData.name;
            
            // é¢æ¥é–‹å§‹çŠ¶æ…‹ã«æ›´æ–°
            window.alsokStorage.updateApplicant(applicantId, {
                status: 'interview_started'
            });
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners();
            
            // æœ€åˆã®è³ªå•ã‚’è¡¨ç¤º
            setTimeout(() => {
                showNextQuestion();
            }, 2000);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // é€ä¿¡ãƒœã‚¿ãƒ³
            sendBtn.addEventListener('click', submitAnswer);
            
            // å…¥åŠ›æ¬„ã®å¤‰æ›´ç›£è¦–
            answerInput.addEventListener('input', handleInputChange);
            
            // Enterã‚­ãƒ¼ã§é€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
            answerInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        submitAnswer();
                    }
                }
            });
        }
        
        // å…¥åŠ›å¤‰æ›´å‡¦ç†
        function handleInputChange() {
            const text = answerInput.value.trim();
            const length = text.length;
            
            // æ–‡å­—æ•°æ›´æ–°
            charCount.textContent = length;
            
            // é€ä¿¡ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            sendBtn.disabled = length === 0 || length > 500 || isProcessing;
            
            // æ–‡å­—æ•°åˆ¶é™ã®è­¦å‘Š
            if (length > 450) {
                charCount.className = length > 500 ? 'text-red-600 font-semibold' : 'text-yellow-600';
            } else {
                charCount.className = 'text-gray-500';
            }
        }
        
        // æ¬¡ã®è³ªå•ã‚’è¡¨ç¤º
        function showNextQuestion() {
            if (currentQuestion >= questions.length) {
                completeInterview();
                return;
            }
            
            const question = questions[currentQuestion];
            
            // UIæ›´æ–°
            questionCounter.textContent = question.id;
            progressBar.style.width = `${(question.id / questions.length) * 100}%`;
            interviewStatus.textContent = `è³ªå• ${question.id}`;
            
            // AIè³ªå•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            setTimeout(() => {
                addAIMessage(question.text, question.hint);
                enableInput();
            }, 1000);
        }
        
        // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addAIMessage(text, hint = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-ai rounded-2xl p-4 mb-4 fade-in';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                        ğŸ¤–
                    </div>
                    <div>
                        <div class="font-medium text-gray-800 mb-1">AIé¢æ¥å®˜</div>
                        <div class="text-gray-700 leading-relaxed">
                            ${text}
                        </div>
                        ${hint ? `
                            <div class="text-xs text-gray-500 mt-2 bg-gray-100 rounded-lg p-2">
                                ğŸ’¡ ${hint}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-user rounded-2xl p-4 mb-4 fade-in ml-8';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3 justify-end">
                    <div class="text-right">
                        <div class="font-medium text-white mb-1">ã‚ãªãŸã®å›ç­”</div>
                        <div class="text-white leading-relaxed">
                            ${text.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white text-sm flex-shrink-0 mt-1">
                        ğŸ‘¤
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // å›ç­”é€ä¿¡
        function submitAnswer() {
            const answer = answerInput.value.trim();
            
            if (!answer || isProcessing) {
                return;
            }
            
            isProcessing = true;
            setUIState('sending');
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            addUserMessage(answer);
            
            // å›ç­”ã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            const question = questions[currentQuestion];
            window.alsokStorage.addInterviewResponse(applicantId, question.text, answer);
            
            // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
            answerInput.value = '';
            handleInputChange();
            
            // æ¬¡ã®è³ªå•ã¾ãŸã¯å®Œäº†å‡¦ç†
            currentQuestion++;
            
            setTimeout(() => {
                if (currentQuestion < questions.length) {
                    // æ¬¡ã®è³ªå•
                    showNextQuestion();
                    setUIState('input');
                    isProcessing = false;
                } else {
                    // é¢æ¥å®Œäº†
                    completeInterview();
                }
            }, 2000);
        }
        
        // é¢æ¥å®Œäº†
        function completeInterview() {
            // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            setTimeout(() => {
                addAIMessage(
                    `${applicantData.name}ã•ã‚“ã€é¢æ¥ã¯ä»¥ä¸Šã§çµ‚äº†ã§ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼<br><br>` +
                    `ã™ã¹ã¦ã®è³ªå•ã«ã”å›ç­”ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>` +
                    `é¸è€ƒçµæœã«ã¤ã„ã¦ã¯ã€å¾Œæ—¥æ‹…å½“è€…ã‚ˆã‚Šã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚`
                );
            }, 1000);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            window.alsokStorage.updateApplicant(applicantId, {
                status: 'interview_completed'
            });
            
            interviewStatus.textContent = 'é¢æ¥å®Œäº†';
            setUIState('completed');
            
            // å®Œäº†ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            setTimeout(() => {
                window.location.href = `/completed?id=${applicantId}`;
            }, 5000);
        }
        
        // UIçŠ¶æ…‹ç®¡ç†
        function setUIState(state) {
            const answerForm = document.getElementById('answer-form');
            const sendingState = document.getElementById('sending-state');
            const completedState = document.getElementById('completed-state');
            
            // ã™ã¹ã¦éè¡¨ç¤º
            answerForm.classList.add('hidden');
            sendingState.classList.add('hidden');
            completedState.classList.add('hidden');
            
            // è©²å½“çŠ¶æ…‹ã‚’è¡¨ç¤º
            switch (state) {
                case 'input':
                    answerForm.classList.remove('hidden');
                    break;
                case 'sending':
                    sendingState.classList.remove('hidden');
                    break;
                case 'completed':
                    completedState.classList.remove('hidden');
                    break;
            }
        }
        
        // å…¥åŠ›æœ‰åŠ¹åŒ–
        function enableInput() {
            setUIState('input');
            answerInput.focus();
        }
        
        // ãƒãƒ£ãƒƒãƒˆæœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }
        
        // ãƒšãƒ¼ã‚¸é›¢è„±ç¢ºèª
        window.addEventListener('beforeunload', function(e) {
            if (currentQuestion > 0 && currentQuestion < questions.length) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>